# 01-安装与环境配置

本文档详细介绍如何安装和配置 Qlib 量化投资平台的环境。

## 一、Python 版本要求

### 推荐版本
- **Python 3.8**（最推荐，兼容性最好）
- Python 3.7（支持）
- Python 3.9（部分功能可能受限）

### 不推荐版本
- Python 3.10+（可能存在兼容性问题，特别是 Cython 编译部分）

### 检查 Python 版本
```bash
python --version
# 或
python3 --version
```

如果版本不符合要求，请先安装或升级 Python。

## 二、创建虚拟环境（强烈推荐）

使用虚拟环境可以避免依赖包冲突，强烈建议为 Qlib 创建独立的虚拟环境。

### 方法1：使用 Conda（推荐）

```bash
# 创建名为 qlib_env 的虚拟环境，Python 版本为 3.8
conda create -n qlib_env python=3.8

# 激活虚拟环境
conda activate qlib_env
```

### 方法2：使用 venv

```bash
# 创建虚拟环境
python3 -m venv qlib_env

# 激活虚拟环境
# macOS/Linux:
source qlib_env/bin/activate
# Windows:
qlib_env\Scripts\activate
```

激活成功后，命令行提示符前会显示 `(qlib_env)`。

## 三、安装前置依赖

在安装 Qlib 之前，必须先安装以下基础依赖：

### 1. 安装 NumPy
```bash
pip install numpy
```

### 2. 安装并升级 Cython（重要！）
```bash
pip install --upgrade cython
```

**注意**：Cython 是必需的，因为 Qlib 包含一些需要编译的 C++ 扩展模块。

### 3. Windows 用户特殊要求

如果您使用的是 Windows 系统，需要安装 **Microsoft Visual C++ 14.0 或更高版本**的生成工具。

**下载地址**：
- [Visual Studio Build Tools](https://visualstudio.microsoft.com/visual-cpp-build-tools/)

**安装步骤**：
1. 下载并运行安装程序
2. 选择 "C++ 生成工具" 工作负载
3. 完成安装后重启命令行

如果不安装，在编译 Cython 模块时会报错：`Microsoft Visual C++ 14.0 is required`

## 四、安装 Qlib

Qlib 提供两种安装方式，推荐使用源码安装以便查看示例代码。

### 方法1：Pip 直接安装（简单快速）

```bash
pip install pyqlib
```

### 方法2：源码安装（推荐，便于学习）

```bash
# 1. 克隆 Qlib 仓库
git clone https://github.com/microsoft/qlib.git
cd qlib

# 2. 安装 Qlib
python setup.py install
```

**源码安装的优点**：
- 可以查看和修改源代码
- 可以访问官方示例代码
- 便于理解 Qlib 的内部实现

## 五、验证安装

安装完成后，验证 Qlib 是否成功安装：

```python
import qlib
print(qlib.__version__)
```

如果能够正常输出版本号（如 `0.9.x`），说明安装成功。

### 完整验证脚本

创建一个测试文件 `test_installation.py`：

```python
#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
Qlib 安装验证脚本
"""

try:
    import qlib
    print(f"✅ Qlib 安装成功！版本: {qlib.__version__}")

    # 检查关键模块
    from qlib.constant import REG_CN, REG_US
    from qlib.data import D
    print("✅ 核心模块导入成功")

    print("\n🎉 安装验证通过！可以开始使用 Qlib 了。")

except ImportError as e:
    print(f"❌ 导入失败: {e}")
    print("请检查安装是否正确")
except Exception as e:
    print(f"❌ 验证过程出错: {e}")
```

运行验证：
```bash
python test_installation.py
```

## 六、安装其他可选依赖

根据您的需求，可能需要安装以下可选依赖：

### LightGBM（用于模型训练）
```bash
pip install lightgbm
```

### PyTorch（用于深度学习模型，可选）
```bash
# CPU 版本
pip install torch

# GPU 版本（如果有 NVIDIA GPU）
pip install torch torchvision torchaudio
```

### Redis（用于缓存加速，可选）
```bash
pip install redis
```

## 七、常见安装问题

### 问题1：Cython 编译错误

**错误信息**：
```
error: Microsoft Visual C++ 14.0 is required
```

**解决方案**：
- Windows 用户：安装 Visual Studio Build Tools（见上文）
- macOS/Linux 用户：确保已安装编译工具链
  ```bash
  # macOS
  xcode-select --install

  # Ubuntu/Debian
  sudo apt-get install build-essential
  ```

### 问题2：找不到 qlib.data._libs.rolling 模块

**错误信息**：
```
ModuleNotFoundError: No module named 'qlib.data._libs.rolling'
```

**解决方案**：
如果使用源码安装，需要重新编译 Cython 扩展：
```bash
cd qlib
python setup.py build_ext --inplace
python setup.py install
```

### 问题3：pip 安装缓慢或失败

**解决方案**：
使用国内镜像源加速：
```bash
pip install -i https://pypi.tuna.tsinghua.edu.cn/simple pyqlib
```

### 问题4：Python 版本不兼容

**错误信息**：
```
SyntaxError: invalid syntax
```

**解决方案**：
确保使用 Python 3.7-3.9 版本，不要使用 Python 3.10+。

### 问题5：依赖包版本冲突

**解决方案**：
在虚拟环境中重新安装：
```bash
# 创建新的虚拟环境
conda create -n qlib_env_new python=3.8
conda activate qlib_env_new

# 按顺序安装
pip install numpy
pip install --upgrade cython
pip install pyqlib
```

## 八、下一步

安装完成后，请继续阅读：
- **[02-数据准备.md](02-数据准备.md)** - 下载和准备数据

## 九、环境检查清单

在继续之前，请确认：

- [ ] Python 版本为 3.7-3.9（推荐 3.8）
- [ ] 已创建并激活虚拟环境
- [ ] 已安装 numpy 和 cython
- [ ] 已成功安装 Qlib
- [ ] 验证脚本运行成功
- [ ] （Windows 用户）已安装 Visual C++ Build Tools

如果所有项目都已完成，恭喜您！环境配置成功，可以开始使用 Qlib 了。
