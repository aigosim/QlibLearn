# 11-每日选股实盘方案

本文档提供将每日选股结果用于实盘交易的完整方案，包括目标持仓计算、调仓计算和交易计划制定，帮助您将选股结果转化为实际的交易操作。

## 一、概述

### 基本流程

将每日选股结果用于实盘交易的基本流程：

```
选股结果 → 目标持仓计算 → 查询当前持仓 → 调仓计算 → 交易计划 → 手动执行
```

### 核心步骤

1. **获取选股结果**：从每日选股工具获取目标持仓股票列表
2. **计算目标持仓**：根据总资产和权重分配，计算每只股票的目标数量
3. **查询当前持仓**：从交易账户查询当前实际持仓
4. **计算调仓差额**：对比目标持仓和当前持仓，计算买入/卖出数量
5. **制定交易计划**：生成详细的买入/卖出清单
6. **执行交易**：根据交易计划手动下单

### 手动执行的优势

- **完全控制**：每一步都可以人工审核和调整
- **风险可控**：可以随时停止或修改交易计划
- **学习理解**：通过手动计算加深对策略的理解
- **灵活调整**：可以根据实际情况灵活调整

### 重要提示

⚠️ **风险提示**：
- 本方案仅用于学习目的，不构成投资建议
- 实盘交易存在风险，请谨慎操作
- 建议先进行充分回测，再考虑实盘应用
- 实盘交易前请充分了解相关风险

## 二、选股结果解读

### 选股结果格式

每日选股工具会输出如下格式的结果：

```
选股结果 (2024-01-16)
========================================
排名  股票代码    预测分数
1     SH000001   0.1234
2     SH000002   0.1156
3     SH000003   0.1098
...
10    SH000010   0.0987
========================================
```

### 结果解读

- **排名**：根据预测分数从高到低排序
- **股票代码**：目标持仓的股票代码（如 SH000001）
- **预测分数**：模型综合所有特征后的预测分数，分数越高表示模型认为未来表现越好

### 目标持仓股票列表

选股结果中的股票列表就是**目标持仓**，即我们希望持有的股票组合。

**示例**：
- 如果选股结果包含 10 只股票，则目标持仓就是这 10 只股票
- 如果选股结果包含 50 只股票，则目标持仓就是这 50 只股票

## 三、目标持仓计算

### 等权重分配方法

**等权重分配**是最简单常用的方法，即每只股票分配相同的资金权重。

#### 计算公式

```
每只股票权重 = 1 / 目标持仓股票数量
每只股票目标金额 = 总资产 × 每只股票权重
每只股票目标数量 = 每只股票目标金额 / 当前价格
```

#### 计算步骤

1. **确定总资产**
   - 查询交易账户的总资产（包括现金和持仓市值）

2. **计算每只股票权重**
   - 如果目标持仓有 10 只股票，每只股票权重 = 1/10 = 10%
   - 如果目标持仓有 50 只股票，每只股票权重 = 1/50 = 2%

3. **计算每只股票目标金额**
   - 目标金额 = 总资产 × 权重

4. **计算每只股票目标数量**
   - 查询每只股票的当前价格
   - 目标数量 = 目标金额 / 当前价格
   - **注意**：A股需要向下取整到 100 股的整数倍

### 计算示例

**场景设定**：
- 总资产：1,000,000 元（100万）
- 目标持仓：10 只股票（topk=10）
- 股票A当前价格：10.50 元

**计算过程**：

```
1. 每只股票权重 = 1 / 10 = 10%

2. 每只股票目标金额 = 1,000,000 × 10% = 100,000 元

3. 股票A目标数量 = 100,000 / 10.50 = 9,523.81 股

4. 向下取整到100股整数倍 = 9,500 股

5. 股票A目标金额（调整后）= 9,500 × 10.50 = 99,750 元
```

### 目标持仓表格

制作目标持仓表格，记录每只股票的信息：

| 排名 | 股票代码 | 当前价格 | 权重 | 目标金额 | 目标数量 |
|------|---------|---------|------|---------|---------|
| 1 | SH000001 | 10.50 | 10% | 100,000 | 9,500 |
| 2 | SH000002 | 25.30 | 10% | 100,000 | 3,900 |
| ... | ... | ... | ... | ... | ... |

**说明**：
- 当前价格：查询实时价格或前一交易日收盘价
- 目标数量：需要向下取整到 100 股整数倍（A股要求）
- 实际目标金额：目标数量 × 当前价格（可能与理论目标金额略有差异）

## 四、当前持仓查询

### 查询方法

从交易账户查询当前实际持仓，需要记录以下信息：

- **股票代码**：持有的股票代码
- **持仓数量**：当前持有的股数
- **成本价**：买入成本价（用于计算盈亏）
- **当前价格**：当前市价（用于计算市值）
- **持仓市值**：持仓数量 × 当前价格

### 持仓记录表格

制作当前持仓表格：

| 股票代码 | 持仓数量 | 成本价 | 当前价格 | 持仓市值 | 盈亏 |
|---------|---------|--------|---------|---------|------|
| SH000001 | 10,000 | 10.00 | 10.50 | 105,000 | +5,000 |
| SH000005 | 5,000 | 20.00 | 18.50 | 92,500 | -7,500 |
| ... | ... | ... | ... | ... | ... |

**总资产计算**：
```
总资产 = 现金余额 + 所有持仓市值之和
```

### 注意事项

1. **查询时间**：建议在盘后查询，确保数据准确
2. **价格确认**：使用前一交易日收盘价或当日实时价格
3. **数量确认**：确认持仓数量准确，包括当日已成交但未结算的订单

## 五、调仓计算

### 对比目标持仓和当前持仓

将目标持仓表格和当前持仓表格进行对比，计算每只股票的调仓差额。

### 调仓计算公式

```
调仓差额 = 目标数量 - 当前数量

如果 调仓差额 > 0：需要买入（买入数量 = 调仓差额）
如果 调仓差额 < 0：需要卖出（卖出数量 = |调仓差额|）
如果 调仓差额 = 0：无需操作
```

### 调仓计算表格

制作调仓计算表格：

| 股票代码 | 目标数量 | 当前数量 | 调仓差额 | 操作 | 操作数量 |
|---------|---------|---------|---------|------|---------|
| SH000001 | 9,500 | 10,000 | -500 | 卖出 | 500 |
| SH000002 | 3,900 | 0 | +3,900 | 买入 | 3,900 |
| SH000003 | 4,200 | 4,200 | 0 | 无需操作 | 0 |
| SH000005 | 0 | 5,000 | -5,000 | 卖出 | 5,000 |
| ... | ... | ... | ... | ... | ... |

**说明**：
- **目标数量**：从目标持仓表格获取
- **当前数量**：从当前持仓表格获取，如果没有持仓则为 0
- **调仓差额**：目标数量 - 当前数量
- **操作**：根据差额正负确定买入或卖出
- **操作数量**：调仓差额的绝对值

### 计算示例

**场景**：
- 目标持仓：SH000001 目标数量 9,500 股
- 当前持仓：SH000001 当前数量 10,000 股

**计算**：
```
调仓差额 = 9,500 - 10,000 = -500

因为差额 < 0，所以需要卖出
卖出数量 = 500 股
```

## 六、交易计划制定

### 交易计划表格

根据调仓计算结果，制定详细的交易计划：

#### 买入清单

| 序号 | 股票代码 | 买入数量 | 当前价格 | 预计金额 | 备注 |
|------|---------|---------|---------|---------|------|
| 1 | SH000002 | 3,900 | 25.30 | 98,670 | 新买入 |
| 2 | SH000007 | 2,000 | 15.80 | 31,600 | 新买入 |
| ... | ... | ... | ... | ... | ... |
| **合计** | - | - | - | **XXX** | - |

#### 卖出清单

| 序号 | 股票代码 | 卖出数量 | 当前价格 | 预计金额 | 盈亏 | 备注 |
|------|---------|---------|---------|---------|------|------|
| 1 | SH000001 | 500 | 10.50 | 5,250 | +250 | 减仓 |
| 2 | SH000005 | 5,000 | 18.50 | 92,500 | -7,500 | 清仓 |
| ... | ... | ... | ... | ... | ... | ... |
| **合计** | - | - | - | **XXX** | - | - |

#### 无需操作清单

| 股票代码 | 目标数量 | 当前数量 | 说明 |
|---------|---------|---------|------|
| SH000003 | 4,200 | 4,200 | 持仓正确，无需调整 |

### 资金检查

**买入总金额**：计算所有买入股票的预计金额总和

**卖出总金额**：计算所有卖出股票的预计金额总和

**资金平衡检查**：
```
可用资金 = 现金余额 + 卖出总金额 - 买入总金额

如果 可用资金 < 0：
  ⚠️ 资金不足，需要减少买入数量或增加卖出数量
如果 可用资金 >= 0：
  ✅ 资金充足，可以执行交易计划
```

### 交易计划确认

在执行交易前，确认：

- [ ] 买入总金额不超过可用资金
- [ ] 所有股票数量都是 100 股的整数倍
- [ ] 没有停牌或涨跌停的股票
- [ ] 交易计划符合风险控制要求

## 七、手动执行步骤

### 步骤1：获取选股结果

运行每日选股工具，获取选股结果：

```bash
python daily_stock_selection.py \
    --model_path ./models/lgb_model.pkl \
    --topk 10 \
    --output_dir ./selection_results
```

**输出**：选股结果文件，包含目标持仓股票列表

### 步骤2：查询当前持仓

从交易账户查询当前实际持仓：

1. 登录交易软件或交易系统
2. 查询持仓信息
3. 记录每只股票的持仓数量、成本价、当前价格
4. 计算总资产 = 现金余额 + 持仓市值

### 步骤3：计算目标持仓

根据选股结果和总资产，计算目标持仓：

1. **确定目标持仓股票**：从选股结果中提取股票列表
2. **查询当前价格**：查询每只股票的当前价格
3. **计算权重**：等权重分配，每只股票权重 = 1 / 股票数量
4. **计算目标金额**：每只股票目标金额 = 总资产 × 权重
5. **计算目标数量**：每只股票目标数量 = 目标金额 / 当前价格（向下取整到100股）

**制作目标持仓表格**

### 步骤4：计算调仓差额

对比目标持仓和当前持仓：

1. **制作对比表格**：将目标持仓和当前持仓合并对比
2. **计算调仓差额**：调仓差额 = 目标数量 - 当前数量
3. **确定操作类型**：
   - 差额 > 0：买入
   - 差额 < 0：卖出
   - 差额 = 0：无需操作

**制作调仓计算表格**

### 步骤5：制定交易计划

根据调仓计算结果，制定交易计划：

1. **买入清单**：列出所有需要买入的股票和数量
2. **卖出清单**：列出所有需要卖出的股票和数量
3. **无需操作清单**：列出持仓正确的股票
4. **资金检查**：确认资金充足
5. **风险检查**：检查是否有停牌、涨跌停等风险

**制作交易计划表格**

### 步骤6：执行交易（手动下单）

根据交易计划，在交易软件中手动下单：

#### 卖出操作（优先执行）

1. 打开交易软件
2. 选择"卖出"
3. 输入股票代码
4. 输入卖出数量
5. 选择价格类型（市价或限价）
6. 确认并提交订单

**建议**：先执行卖出操作，释放资金后再买入

#### 买入操作

1. 卖出操作完成后，确认可用资金
2. 打开交易软件
3. 选择"买入"
4. 输入股票代码
5. 输入买入数量
6. 选择价格类型（市价或限价）
7. 确认并提交订单

#### 订单确认

- 确认订单已提交
- 监控订单执行状态
- 记录实际成交价格和数量
- 更新持仓记录

## 八、完整示例

### 场景设定

- **日期**：2024年1月16日（盘后）
- **总资产**：1,000,000 元（100万）
- **现金余额**：50,000 元
- **持仓市值**：950,000 元
- **选股结果**：10 只股票（topk=10）

### 选股结果

```
选股结果 (2024-01-16)
========================================
排名  股票代码    预测分数
1     SH000001   0.1234
2     SH000002   0.1156
3     SH000003   0.1098
4     SH000004   0.1089
5     SH000005   0.1076
6     SH000006   0.1065
7     SH000007   0.1054
8     SH000008   0.1043
9     SH000009   0.1032
10    SH000010   0.1021
========================================
```

### 当前持仓

| 股票代码 | 持仓数量 | 成本价 | 当前价格 | 持仓市值 |
|---------|---------|--------|---------|---------|
| SH000001 | 10,000 | 10.00 | 10.50 | 105,000 |
| SH000003 | 4,200 | 12.00 | 12.50 | 52,500 |
| SH000011 | 8,000 | 15.00 | 14.80 | 118,400 |
| SH000012 | 6,000 | 20.00 | 22.00 | 132,000 |
| ... | ... | ... | ... | ... |

### 目标持仓计算

**每只股票权重** = 1 / 10 = 10%

**每只股票目标金额** = 1,000,000 × 10% = 100,000 元

**目标持仓表格**：

| 排名 | 股票代码 | 当前价格 | 权重 | 目标金额 | 目标数量 |
|------|---------|---------|------|---------|---------|
| 1 | SH000001 | 10.50 | 10% | 100,000 | 9,500 |
| 2 | SH000002 | 25.30 | 10% | 100,000 | 3,900 |
| 3 | SH000003 | 12.50 | 10% | 100,000 | 8,000 |
| 4 | SH000004 | 18.20 | 10% | 100,000 | 5,400 |
| 5 | SH000005 | 22.50 | 10% | 100,000 | 4,400 |
| 6 | SH000006 | 16.80 | 10% | 100,000 | 5,900 |
| 7 | SH000007 | 15.80 | 10% | 100,000 | 6,300 |
| 8 | SH000008 | 19.50 | 10% | 100,000 | 5,100 |
| 9 | SH000009 | 21.20 | 10% | 100,000 | 4,700 |
| 10 | SH000010 | 17.60 | 10% | 100,000 | 5,600 |

### 调仓计算

| 股票代码 | 目标数量 | 当前数量 | 调仓差额 | 操作 | 操作数量 |
|---------|---------|---------|---------|------|---------|
| SH000001 | 9,500 | 10,000 | -500 | 卖出 | 500 |
| SH000002 | 3,900 | 0 | +3,900 | 买入 | 3,900 |
| SH000003 | 8,000 | 4,200 | +3,800 | 买入 | 3,800 |
| SH000004 | 5,400 | 0 | +5,400 | 买入 | 5,400 |
| SH000005 | 4,400 | 0 | +4,400 | 买入 | 4,400 |
| SH000006 | 5,900 | 0 | +5,900 | 买入 | 5,900 |
| SH000007 | 6,300 | 0 | +6,300 | 买入 | 6,300 |
| SH000008 | 5,100 | 0 | +5,100 | 买入 | 5,100 |
| SH000009 | 4,700 | 0 | +4,700 | 买入 | 4,700 |
| SH000010 | 5,600 | 0 | +5,600 | 买入 | 5,600 |
| SH000011 | 0 | 8,000 | -8,000 | 卖出 | 8,000 |
| SH000012 | 0 | 6,000 | -6,000 | 卖出 | 6,000 |

### 交易计划

#### 卖出清单

| 序号 | 股票代码 | 卖出数量 | 当前价格 | 预计金额 | 备注 |
|------|---------|---------|---------|---------|------|
| 1 | SH000001 | 500 | 10.50 | 5,250 | 减仓 |
| 2 | SH000011 | 8,000 | 14.80 | 118,400 | 清仓（不在目标持仓） |
| 3 | SH000012 | 6,000 | 22.00 | 132,000 | 清仓（不在目标持仓） |
| **合计** | - | - | - | **255,650** | - |

#### 买入清单

| 序号 | 股票代码 | 买入数量 | 当前价格 | 预计金额 | 备注 |
|------|---------|---------|---------|---------|------|
| 1 | SH000002 | 3,900 | 25.30 | 98,670 | 新买入 |
| 2 | SH000003 | 3,800 | 12.50 | 47,500 | 加仓 |
| 3 | SH000004 | 5,400 | 18.20 | 98,280 | 新买入 |
| 4 | SH000005 | 4,400 | 22.50 | 99,000 | 新买入 |
| 5 | SH000006 | 5,900 | 16.80 | 99,120 | 新买入 |
| 6 | SH000007 | 6,300 | 15.80 | 99,540 | 新买入 |
| 7 | SH000008 | 5,100 | 19.50 | 99,450 | 新买入 |
| 8 | SH000009 | 4,700 | 21.20 | 99,640 | 新买入 |
| 9 | SH000010 | 5,600 | 17.60 | 98,560 | 新买入 |
| **合计** | - | - | - | **739,660** | - |

#### 资金检查

```
可用资金 = 现金余额 + 卖出总金额 - 买入总金额
         = 50,000 + 255,650 - 739,660
         = -433,010

⚠️ 资金不足！
```

**解决方案**：
- 减少买入数量
- 或者分批执行（先卖出，再买入）

### 执行结果

**调整后的交易计划**（分批执行）：

**第一批：卖出操作**
- 卖出 SH000011：8,000 股，预计金额 118,400 元
- 卖出 SH000012：6,000 股，预计金额 132,000 元
- 卖出 SH000001：500 股，预计金额 5,250 元
- **卖出合计**：255,650 元

**执行后可用资金** = 50,000 + 255,650 = 305,650 元

**第二批：买入操作**（根据可用资金调整买入数量）
- 按优先级买入目标持仓股票
- 确保总买入金额不超过可用资金

## 九、风险控制建议

### 仓位控制

1. **单只股票上限**：建议单只股票不超过总资产的 20%
2. **持仓数量**：根据资金规模合理设置 topk
3. **现金预留**：建议保留 5-10% 的现金作为缓冲

### 涨跌停处理

1. **涨停股票**：如果目标持仓中有涨停股票，无法买入，可以：
   - 等待下一个交易日
   - 或者用其他股票替代

2. **跌停股票**：如果当前持仓中有跌停股票，无法卖出，可以：
   - 等待下一个交易日
   - 或者调整交易计划

### 停牌股票处理

1. **目标持仓中有停牌股票**：无法买入，跳过该股票
2. **当前持仓中有停牌股票**：无法卖出，保留持仓
3. **调整计划**：根据实际情况调整其他股票的买入数量

### 资金管理

1. **分批执行**：如果资金不足，可以分批执行交易计划
2. **优先级**：优先执行卖出操作，释放资金后再买入
3. **资金监控**：实时监控可用资金，确保买入不超过可用资金

### 风险提示

⚠️ **重要风险提示**：
- 市场有风险，投资需谨慎
- 本方案仅用于学习目的，不构成投资建议
- 实盘交易前请充分了解相关风险
- 建议先进行充分回测，再考虑实盘应用
- 建议从小资金开始，逐步增加

## 十、注意事项

### 交易时间

1. **A股交易时间**：
   - 上午：9:30 - 11:30
   - 下午：13:00 - 15:00
   - 建议在收盘后制定交易计划，次日开盘执行

2. **执行时机**：
   - 建议在开盘后 30 分钟内执行，避免价格大幅波动
   - 或者使用限价单，设定合理的价格区间

### 价格确认

1. **使用价格**：
   - 制定计划时：使用前一交易日收盘价
   - 执行交易时：使用实时价格或限价

2. **价格波动**：
   - 注意价格可能发生变化
   - 如果价格变化较大，需要重新计算

### 数量取整

1. **A股要求**：买入数量必须是 100 股的整数倍
2. **向下取整**：计算目标数量时向下取整到 100 股
3. **实际金额**：实际目标金额 = 实际数量 × 当前价格

### 手续费考虑

1. **买入佣金**：通常为成交金额的 0.05% - 0.3%
2. **卖出佣金**：通常为成交金额的 0.05% - 0.3%
3. **印花税**：卖出时收取，通常为成交金额的 0.1%
4. **最小佣金**：通常为 5 元

**计算示例**：
```
买入 10,000 元股票：
  佣金 = 10,000 × 0.0005 = 5 元（如果小于最小佣金，则按最小佣金收取）
  实际成本 = 10,000 + 5 = 10,005 元

卖出 10,000 元股票：
  佣金 = 10,000 × 0.0005 = 5 元
  印花税 = 10,000 × 0.001 = 10 元
  实际收入 = 10,000 - 5 - 10 = 9,985 元
```

### 滑点考虑

1. **市价单滑点**：使用市价单可能产生滑点，实际成交价格可能与预期不同
2. **限价单**：使用限价单可以控制价格，但可能无法成交
3. **建议**：对于大额交易，可以考虑分批执行或使用限价单

### 数据记录

1. **交易记录**：记录每笔交易的详细信息
2. **持仓更新**：交易完成后及时更新持仓记录
3. **绩效跟踪**：定期跟踪交易绩效，评估策略效果

## 十一、常见问题

### 问题1：如何计算总资产？

**回答**：
```
总资产 = 现金余额 + 所有持仓市值之和

持仓市值 = 持仓数量 × 当前价格
```

**示例**：
- 现金余额：50,000 元
- 持仓1市值：105,000 元
- 持仓2市值：52,500 元
- 总资产 = 50,000 + 105,000 + 52,500 = 207,500 元

### 问题2：如何处理部分成交？

**回答**：
1. **记录实际成交**：记录实际成交的数量和价格
2. **更新持仓**：根据实际成交更新持仓记录
3. **调整计划**：根据实际成交情况调整剩余交易计划
4. **重新计算**：如果成交情况与计划差异较大，可以重新计算

### 问题3：如何处理选股结果变化？

**回答**：
1. **每日更新**：每日重新运行选股工具，获取最新结果
2. **对比变化**：对比新旧选股结果，识别变化
3. **调整计划**：根据新的选股结果调整交易计划
4. **平滑过渡**：如果变化较大，可以分步调整，避免频繁交易

### 问题4：如何记录交易历史？

**回答**：
建议制作交易记录表格：

| 日期 | 股票代码 | 操作 | 数量 | 价格 | 金额 | 手续费 | 备注 |
|------|---------|------|------|------|------|--------|------|
| 2024-01-16 | SH000001 | 卖出 | 500 | 10.50 | 5,250 | 5 | 减仓 |
| 2024-01-16 | SH000002 | 买入 | 3,900 | 25.30 | 98,670 | 5 | 新买入 |
| ... | ... | ... | ... | ... | ... | ... | ... |

### 问题5：资金不足怎么办？

**回答**：
1. **优先卖出**：先执行卖出操作，释放资金
2. **分批执行**：分批执行交易计划，不要一次性买入
3. **减少数量**：减少买入数量，确保资金充足
4. **调整权重**：如果资金长期不足，可以考虑调整权重分配方式

### 问题6：如何验证交易计划？

**回答**：
1. **资金检查**：确认买入总金额不超过可用资金
2. **数量检查**：确认所有数量都是 100 股的整数倍
3. **风险检查**：检查是否有停牌、涨跌停等风险
4. **逻辑检查**：确认调仓逻辑正确，没有遗漏

## 十二、交易计划模板

### Excel 模板结构

建议使用 Excel 制作交易计划表格，包含以下工作表：

1. **选股结果**：从选股工具输出的结果
2. **当前持仓**：当前实际持仓记录
3. **目标持仓**：计算得到的目标持仓
4. **调仓计算**：调仓差额计算
5. **交易计划**：买入/卖出清单
6. **交易记录**：历史交易记录

### Python 辅助脚本（可选）

可以使用 Python 脚本自动生成交易计划清单，大大提高效率并减少计算错误。

#### 脚本功能

完整的交易计划生成脚本应包含以下功能：

1. **读取选股结果**：从选股工具输出或结果文件中读取目标持仓股票列表
2. **读取当前持仓**：从CSV文件或手动输入当前持仓信息
3. **查询股票价格**：自动查询每只股票的当前价格
4. **计算目标持仓**：根据总资产和等权重分配，计算每只股票的目标数量
5. **计算调仓差额**：对比目标持仓和当前持仓，计算买入/卖出数量
6. **生成交易计划**：生成格式化的买入/卖出清单
7. **资金检查**：自动检查资金是否充足，并给出提示
8. **输出结果**：生成可打印的交易计划清单

#### 完整脚本示例

以下是一个完整的交易计划生成脚本示例：

```python
# -*- coding: utf-8 -*-
"""
交易计划生成脚本

功能：
1. 读取选股结果
2. 读取当前持仓
3. 计算目标持仓和调仓差额
4. 生成交易计划清单
"""

import argparse
import csv
import sys
from datetime import datetime
import qlib
from qlib.constant import REG_CN, REG_US
from qlib.data import D


def read_selection_result(file_path):
    """
    读取选股结果文件

    支持格式：
    - CSV格式：股票代码列（如 stock_code 或 instrument）
    - 文本格式：每行一个股票代码
    """
    stocks = []
    try:
        with open(file_path, 'r', encoding='utf-8') as f:
            # 尝试作为CSV读取
            try:
                reader = csv.DictReader(f)
                for row in reader:
                    # 尝试不同的列名
                    stock = row.get('stock_code') or row.get('instrument') or row.get('code')
                    if stock:
                        stocks.append(stock.strip())
            except:
                # 如果不是CSV，按文本文件读取
                f.seek(0)
                for line in f:
                    line = line.strip()
                    if line and not line.startswith('#'):
                        stocks.append(line)
    except Exception as e:
        print(f"❌ 读取选股结果失败: {e}")
        sys.exit(1)

    return stocks


def read_current_positions(file_path):
    """
    读取当前持仓CSV文件

    CSV格式要求：
    stock_code,quantity,cost_price,current_price
    SH000001,10000,10.00,10.50
    """
    positions = {}
    try:
        with open(file_path, 'r', encoding='utf-8') as f:
            reader = csv.DictReader(f)
            for row in reader:
                stock = row.get('stock_code') or row.get('code')
                if stock:
                    positions[stock.strip()] = {
                        'quantity': int(float(row.get('quantity', 0))),
                        'cost_price': float(row.get('cost_price', 0)),
                        'current_price': float(row.get('current_price', 0))
                    }
    except Exception as e:
        print(f"❌ 读取当前持仓失败: {e}")
        sys.exit(1)

    return positions


def get_stock_prices(stocks, region, trade_date):
    """
    查询股票当前价格

    参数:
        stocks: 股票代码列表
        region: 市场区域
        trade_date: 交易日期
    """
    qlib.init(region=region)
    prices = {}

    for stock in stocks:
        try:
            # 查询收盘价
            data = D.features(
                [stock],
                ['$close'],
                start_time=trade_date,
                end_time=trade_date
            )
            if not data.empty:
                price = data.iloc[0, 0]
                prices[stock] = float(price)
            else:
                print(f"⚠️ 无法获取 {stock} 的价格，请手动输入")
                prices[stock] = None
        except Exception as e:
            print(f"⚠️ 查询 {stock} 价格失败: {e}")
            prices[stock] = None

    return prices


def calculate_target_positions(total_assets, stocks, prices):
    """
    计算目标持仓

    参数:
        total_assets: 总资产
        stocks: 股票代码列表
        prices: 股票价格字典
    """
    n_stocks = len(stocks)
    if n_stocks == 0:
        return {}

    weight = 1.0 / n_stocks
    target_amount = total_assets * weight

    target_positions = {}
    for stock in stocks:
        price = prices.get(stock)
        if price is None or price <= 0:
            print(f"⚠️ {stock} 价格无效，跳过")
            continue

        # 计算目标数量（向下取整到100股）
        target_qty = int((target_amount / price) // 100) * 100
        actual_amount = target_qty * price

        target_positions[stock] = {
            'weight': weight,
            'target_amount': target_amount,
            'target_qty': target_qty,
            'actual_amount': actual_amount,
            'price': price
        }

    return target_positions


def calculate_rebalancing(target_positions, current_positions):
    """
    计算调仓差额

    参数:
        target_positions: 目标持仓字典
        current_positions: 当前持仓字典
    """
    rebalancing = {}

    # 处理目标持仓中的股票
    for stock, target in target_positions.items():
        current = current_positions.get(stock, {'quantity': 0})
        current_qty = current['quantity']
        target_qty = target['target_qty']

        diff = target_qty - current_qty
        rebalancing[stock] = {
            'target_qty': target_qty,
            'current_qty': current_qty,
            'diff': diff,
            'action': '买入' if diff > 0 else '卖出' if diff < 0 else '无需操作',
            'action_qty': abs(diff) if diff != 0 else 0,
            'price': target['price']
        }

    # 处理当前持仓中不在目标持仓的股票（需要清仓）
    for stock, current in current_positions.items():
        if stock not in target_positions:
            rebalancing[stock] = {
                'target_qty': 0,
                'current_qty': current['quantity'],
                'diff': -current['quantity'],
                'action': '卖出',
                'action_qty': current['quantity'],
                'price': current.get('current_price', 0)
            }

    return rebalancing


def generate_trading_plan(rebalancing, cash_balance):
    """
    生成交易计划

    参数:
        rebalancing: 调仓计算结果
        cash_balance: 现金余额
    """
    buy_list = []
    sell_list = []
    no_action_list = []

    for stock, info in rebalancing.items():
        if info['action'] == '买入':
            buy_list.append({
                'stock': stock,
                'quantity': info['action_qty'],
                'price': info['price'],
                'amount': info['action_qty'] * info['price']
            })
        elif info['action'] == '卖出':
            sell_list.append({
                'stock': stock,
                'quantity': info['action_qty'],
                'price': info['price'],
                'amount': info['action_qty'] * info['price']
            })
        else:
            no_action_list.append({
                'stock': stock,
                'target_qty': info['target_qty'],
                'current_qty': info['current_qty']
            })

    # 计算总金额
    total_buy_amount = sum(item['amount'] for item in buy_list)
    total_sell_amount = sum(item['amount'] for item in sell_list)

    # 资金检查
    available_cash = cash_balance + total_sell_amount - total_buy_amount

    return {
        'buy_list': buy_list,
        'sell_list': sell_list,
        'no_action_list': no_action_list,
        'total_buy_amount': total_buy_amount,
        'total_sell_amount': total_sell_amount,
        'available_cash': available_cash,
        'cash_balance': cash_balance
    }


def print_trading_plan(plan, trade_date):
    """
    打印交易计划清单
    """
    print("=" * 80)
    print(f"交易计划清单 - {trade_date}")
    print("=" * 80)

    # 卖出清单
    if plan['sell_list']:
        print("\n【卖出清单】")
        print(f"{'序号':<6} {'股票代码':<15} {'卖出数量':<12} {'当前价格':<12} {'预计金额':<15} {'备注':<10}")
        print("-" * 80)
        for idx, item in enumerate(plan['sell_list'], 1):
            remark = "清仓" if item['quantity'] >= 1000 else "减仓"
            print(f"{idx:<6} {item['stock']:<15} {item['quantity']:<12} "
                  f"{item['price']:<12.2f} {item['amount']:<15.2f} {remark:<10}")
        print(f"\n卖出合计: {plan['total_sell_amount']:,.2f} 元")
    else:
        print("\n【卖出清单】")
        print("无卖出操作")

    # 买入清单
    if plan['buy_list']:
        print("\n【买入清单】")
        print(f"{'序号':<6} {'股票代码':<15} {'买入数量':<12} {'当前价格':<12} {'预计金额':<15} {'备注':<10}")
        print("-" * 80)
        for idx, item in enumerate(plan['buy_list'], 1):
            remark = "新买入" if item['quantity'] >= 1000 else "加仓"
            print(f"{idx:<6} {item['stock']:<15} {item['quantity']:<12} "
                  f"{item['price']:<12.2f} {item['amount']:<15.2f} {remark:<10}")
        print(f"\n买入合计: {plan['total_buy_amount']:,.2f} 元")
    else:
        print("\n【买入清单】")
        print("无买入操作")

    # 无需操作清单
    if plan['no_action_list']:
        print("\n【无需操作清单】")
        print(f"{'股票代码':<15} {'目标数量':<12} {'当前数量':<12} {'说明':<20}")
        print("-" * 80)
        for item in plan['no_action_list']:
            print(f"{item['stock']:<15} {item['target_qty']:<12} "
                  f"{item['current_qty']:<12} {'持仓正确，无需调整':<20}")

    # 资金检查
    print("\n【资金检查】")
    print(f"现金余额: {plan['cash_balance']:,.2f} 元")
    print(f"卖出总金额: {plan['total_sell_amount']:,.2f} 元")
    print(f"买入总金额: {plan['total_buy_amount']:,.2f} 元")
    print(f"执行后可用资金: {plan['available_cash']:,.2f} 元")

    if plan['available_cash'] < 0:
        print("\n⚠️ 警告：资金不足！")
        print("建议：")
        print("  1. 先执行卖出操作，释放资金")
        print("  2. 减少买入数量")
        print("  3. 分批执行交易计划")
    else:
        print("\n✅ 资金充足，可以执行交易计划")

    print("\n" + "=" * 80)


def save_trading_plan(plan, output_file, trade_date):
    """
    保存交易计划到CSV文件
    """
    try:
        with open(output_file, 'w', encoding='utf-8', newline='') as f:
            writer = csv.writer(f)
            writer.writerow(['交易计划清单', trade_date])
            writer.writerow([])

            # 卖出清单
            writer.writerow(['卖出清单'])
            writer.writerow(['序号', '股票代码', '卖出数量', '当前价格', '预计金额', '备注'])
            for idx, item in enumerate(plan['sell_list'], 1):
                remark = "清仓" if item['quantity'] >= 1000 else "减仓"
                writer.writerow([
                    idx, item['stock'], item['quantity'],
                    f"{item['price']:.2f}", f"{item['amount']:.2f}", remark
                ])
            writer.writerow(['卖出合计', '', '', '', f"{plan['total_sell_amount']:.2f}", ''])

            writer.writerow([])

            # 买入清单
            writer.writerow(['买入清单'])
            writer.writerow(['序号', '股票代码', '买入数量', '当前价格', '预计金额', '备注'])
            for idx, item in enumerate(plan['buy_list'], 1):
                remark = "新买入" if item['quantity'] >= 1000 else "加仓"
                writer.writerow([
                    idx, item['stock'], item['quantity'],
                    f"{item['price']:.2f}", f"{item['amount']:.2f}", remark
                ])
            writer.writerow(['买入合计', '', '', '', f"{plan['total_buy_amount']:.2f}", ''])

            writer.writerow([])

            # 资金检查
            writer.writerow(['资金检查'])
            writer.writerow(['项目', '金额'])
            writer.writerow(['现金余额', f"{plan['cash_balance']:.2f}"])
            writer.writerow(['卖出总金额', f"{plan['total_sell_amount']:.2f}"])
            writer.writerow(['买入总金额', f"{plan['total_buy_amount']:.2f}"])
            writer.writerow(['执行后可用资金', f"{plan['available_cash']:.2f}"])

        print(f"\n✅ 交易计划已保存到: {output_file}")
    except Exception as e:
        print(f"❌ 保存交易计划失败: {e}")


def main():
    parser = argparse.ArgumentParser(description='生成交易计划清单')
    parser.add_argument('--selection_file', type=str, required=True,
                        help='选股结果文件路径（CSV或文本格式）')
    parser.add_argument('--positions_file', type=str, required=True,
                        help='当前持仓CSV文件路径')
    parser.add_argument('--total_assets', type=float, required=True,
                        help='总资产（元）')
    parser.add_argument('--cash_balance', type=float, required=True,
                        help='现金余额（元）')
    parser.add_argument('--trade_date', type=str, required=True,
                        help='交易日期（YYYY-MM-DD）')
    parser.add_argument('--region', type=str, default='cn', choices=['cn', 'us'],
                        help='市场区域（cn=中国，us=美国）')
    parser.add_argument('--output', type=str, default='trading_plan.csv',
                        help='输出文件路径（默认：trading_plan.csv）')
    parser.add_argument('--provider_uri', type=str, default='~/.qlib/qlib_data/cn_data',
                        help='Qlib数据路径')

    args = parser.parse_args()

    # 初始化Qlib
    region = REG_CN if args.region == 'cn' else REG_US
    qlib.init(provider_uri=args.provider_uri, region=region)

    print("=" * 80)
    print("交易计划生成工具")
    print("=" * 80)

    # 1. 读取选股结果
    print("\n[1/6] 读取选股结果...")
    target_stocks = read_selection_result(args.selection_file)
    print(f"✅ 读取到 {len(target_stocks)} 只目标持仓股票")

    # 2. 读取当前持仓
    print("\n[2/6] 读取当前持仓...")
    current_positions = read_current_positions(args.positions_file)
    print(f"✅ 读取到 {len(current_positions)} 只当前持仓股票")

    # 3. 查询股票价格
    print("\n[3/6] 查询股票价格...")
    all_stocks = list(set(target_stocks + list(current_positions.keys())))
    prices = get_stock_prices(all_stocks, region, args.trade_date)
    print(f"✅ 查询到 {len([p for p in prices.values() if p is not None])} 只股票的价格")

    # 4. 计算目标持仓
    print("\n[4/6] 计算目标持仓...")
    target_positions = calculate_target_positions(
        args.total_assets, target_stocks, prices
    )
    print(f"✅ 计算出 {len(target_positions)} 只股票的目标持仓")

    # 5. 计算调仓差额
    print("\n[5/6] 计算调仓差额...")
    rebalancing = calculate_rebalancing(target_positions, current_positions)
    print(f"✅ 计算出调仓差额")

    # 6. 生成交易计划
    print("\n[6/6] 生成交易计划...")
    plan = generate_trading_plan(rebalancing, args.cash_balance)

    # 打印交易计划
    print_trading_plan(plan, args.trade_date)

    # 保存交易计划
    save_trading_plan(plan, args.output, args.trade_date)

    print("\n✅ 交易计划生成完成！")


if __name__ == '__main__':
    main()
```

#### 使用方法

**1. 准备选股结果文件**

选股结果文件可以是CSV格式或文本格式：

**CSV格式示例** (`selection_result.csv`):
```csv
stock_code
SH000001
SH000002
SH000003
```

**文本格式示例** (`selection_result.txt`):
```
SH000001
SH000002
SH000003
```

**2. 准备当前持仓文件**

当前持仓文件必须是CSV格式 (`current_positions.csv`):
```csv
stock_code,quantity,cost_price,current_price
SH000001,10000,10.00,10.50
SH000003,4200,12.00,12.50
SH000011,8000,15.00,14.80
```

**3. 运行脚本**

```bash
python examples/07_generate_trading_plan.py \
    --selection_file selection_result.csv \
    --positions_file current_positions.csv \
    --total_assets 1000000 \
    --cash_balance 50000 \
    --trade_date 2024-01-16 \
    --region cn \
    --output trading_plan_20240116.csv
```

**4. 查看输出**

脚本会：
- 在控制台打印格式化的交易计划清单
- 保存交易计划到CSV文件，方便打印和记录

#### 脚本优势

使用脚本辅助生成交易计划清单的优势：

1. **自动化计算**：自动完成所有计算，减少人工错误
2. **价格查询**：自动查询股票价格，无需手动输入
3. **资金检查**：自动检查资金是否充足，并给出提示
4. **格式化输出**：生成格式化的清单，方便打印和执行
5. **可追溯**：保存交易计划到文件，便于后续回顾和分析
6. **灵活扩展**：可以根据需要扩展功能（如手续费计算、风险检查等）

#### 注意事项

1. **数据准确性**：确保选股结果文件和当前持仓文件的数据准确
2. **价格确认**：脚本查询的价格是前一交易日收盘价，执行时请确认实时价格
3. **资金预留**：建议在总资产中预留一定比例作为缓冲
4. **手动审核**：生成交易计划后，请手动审核确认后再执行
5. **分批执行**：如果资金不足，可以分批执行交易计划

#### 扩展功能建议

可以根据需要扩展脚本功能：

1. **手续费计算**：自动计算买入/卖出手续费和印花税
2. **风险检查**：检查是否有停牌、涨跌停等风险
3. **历史记录**：记录历史交易计划，便于分析
4. **邮件通知**：生成交易计划后自动发送邮件
5. **Excel导出**：导出为Excel格式，便于进一步编辑

## 十三、相关文档

- **[10-每日选股执行方案.md](10-每日选股执行方案.md)** - 每日选股执行方案
- **[07-选股策略.md](07-选股策略.md)** - 选股策略详解
- **[08-命令行选股工具.md](08-命令行选股工具.md)** - 选股工具使用说明
- **[12-模型预测与选股原理.md](12-模型预测与选股原理.md)** - 模型预测和选股原理

## 十四、总结

### 核心流程

```
选股结果 → 目标持仓计算 → 查询当前持仓 → 调仓计算 → 交易计划 → 手动执行
```

### 关键要点

1. **等权重分配**：每只股票分配相同的资金权重
2. **调仓计算**：对比目标持仓和当前持仓，计算买入/卖出数量
3. **资金管理**：确保买入总金额不超过可用资金
4. **风险控制**：注意涨跌停、停牌等风险
5. **手动执行**：完全控制，可以随时调整

### 执行检查清单

在执行交易前，请确认：

- [ ] 已获取选股结果
- [ ] 已查询当前持仓
- [ ] 已计算目标持仓
- [ ] 已计算调仓差额
- [ ] 已制定交易计划
- [ ] 已进行资金检查
- [ ] 已进行风险检查
- [ ] 已确认交易时间

如果所有项目都已完成，您可以开始执行交易计划了！

⚠️ **再次提醒**：实盘交易存在风险，请谨慎操作，建议先进行充分回测和学习。
