# 03-基础使用

本文档介绍 Qlib 的基础使用方法，包括初始化、数据查询等核心功能。

## 一、Qlib 初始化

在使用 Qlib 之前，必须先进行初始化，指定数据路径和市场区域。

### A 股市场初始化

```python
import qlib
from qlib.constant import REG_CN

# 初始化 Qlib（A 股市场）
qlib.init(
    provider_uri='~/.qlib/qlib_data/cn_data',  # 数据路径
    region=REG_CN  # 市场区域：A 股
)
```

### 美股市场初始化

```python
import qlib
from qlib.constant import REG_US

# 初始化 Qlib（美股市场）
qlib.init(
    provider_uri='~/.qlib/qlib_data/us_data',  # 数据路径
    region=REG_US  # 市场区域：美股
)
```

### 初始化参数说明

- **provider_uri**：数据存储路径，支持 `~` 表示用户主目录
- **region**：市场区域，`REG_CN` 表示 A 股，`REG_US` 表示美股

### 注意事项

1. **路径格式**：可以使用绝对路径或相对路径，`~` 会被自动展开
2. **多次初始化**：如果已经初始化过，再次调用 `qlib.init()` 会重新初始化
3. **数据检查**：初始化时会检查数据是否存在，如果数据不存在会报错

## 二、数据查询基础

Qlib 提供了 `D` 对象（Data API）来进行数据查询，这是最常用的数据访问接口。

### 导入数据 API

```python
from qlib.data import D
```

## 三、获取交易日历

交易日历用于确定哪些日期是交易日。

### 基本用法

```python
from qlib.data import D

# 获取指定时间段的交易日历
calendar = D.calendar(start_time='2020-01-01', end_time='2020-12-31')
print(f"交易日数量: {len(calendar)}")
print(f"前10个交易日:\n{calendar[:10]}")
```

### 参数说明

- **start_time**：开始日期（字符串格式：'YYYY-MM-DD'）
- **end_time**：结束日期（字符串格式：'YYYY-MM-DD'）

### 输出示例

```
交易日数量: 244
前10个交易日:
DatetimeIndex(['2020-01-02', '2020-01-03', '2020-01-06', ...], dtype='datetime64[ns]', freq=None)
```

## 四、获取股票池

股票池（instruments）定义了要查询的股票集合。

### A 股市场股票池

```python
from qlib.data import D

# 获取 CSI300 成分股
instruments = D.instruments(market='csi300')
print(f"CSI300 股票数量: {len(instruments)}")
print(f"前10只股票: {list(instruments)[:10]}")
```

### 可用的股票池

**A 股市场**：
- `csi300`：沪深300成分股
- `csi500`：中证500成分股
- `csi800`：中证800成分股
- `all`：全市场股票

**美股市场**：
- `all`：全市场股票
- `sp500`：标普500成分股（如果数据中包含）

### 输出示例

```
CSI300 股票数量: 300
前10只股票: ['SH000001', 'SH000002', 'SH000009', ...]
```

## 五、获取特征数据

特征数据是量化分析的核心，包括价格、成交量等基础数据，以及各种计算得到的因子。

### 基本用法

```python
from qlib.data import D

# 获取股票池
instruments = D.instruments(market='csi300')

# 获取前5只股票的数据
sample_stocks = list(instruments)[:5]

# 查询收盘价和成交量
data = D.features(
    instruments=sample_stocks,
    fields=['$close', '$volume'],  # 字段列表
    start_time='2020-01-01',
    end_time='2020-01-31'
)

print(data.head())
```

### 常用字段

Qlib 使用 `$` 前缀表示基础字段：

- `$open`：开盘价
- `$close`：收盘价
- `$high`：最高价
- `$low`：最低价
- `$volume`：成交量
- `$vwap`：成交量加权平均价

### 参数说明

- **instruments**：股票列表或股票池
- **fields**：要查询的字段列表
- **start_time**：开始日期
- **end_time**：结束日期

### 输出示例

```
                            $close  $volume
instrument datetime
SH000001   2020-01-02       10.50   1234567
           2020-01-03       10.60   1234568
           ...
```

## 六、数据查询进阶

### 查询单个股票

```python
from qlib.data import D

# 查询单个股票的数据
data = D.features(
    instruments=['SH000001'],  # 单个股票代码
    fields=['$close', '$volume'],
    start_time='2020-01-01',
    end_time='2020-12-31'
)
```

### 查询多个字段

```python
from qlib.data import D

instruments = D.instruments(market='csi300')
sample_stocks = list(instruments)[:10]

# 查询多个字段
data = D.features(
    instruments=sample_stocks,
    fields=[
        '$close',      # 收盘价
        '$open',       # 开盘价
        '$high',       # 最高价
        '$low',        # 最低价
        '$volume',     # 成交量
    ],
    start_time='2020-01-01',
    end_time='2020-12-31'
)
```

### 数据形状和索引

```python
from qlib.data import D

instruments = D.instruments(market='csi300')
sample_stocks = list(instruments)[:5]

data = D.features(
    instruments=sample_stocks,
    fields=['$close'],
    start_time='2020-01-01',
    end_time='2020-01-31'
)

# 查看数据形状
print(f"数据形状: {data.shape}")  # (交易日数 × 股票数, 字段数)

# 查看索引
print(f"索引层级: {data.index.names}")  # ['instrument', 'datetime']

# 重置索引（如果需要）
data_reset = data.reset_index()
print(data_reset.head())
```

## 七、完整示例

以下是一个完整的基础使用示例：

```python
#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
Qlib 基础使用示例
"""

import qlib
from qlib.constant import REG_CN
from qlib.data import D

def main():
    # 1. 初始化 Qlib
    print("正在初始化 Qlib...")
    qlib.init(provider_uri='~/.qlib/qlib_data/cn_data', region=REG_CN)
    print("✅ Qlib 初始化成功\n")

    # 2. 获取交易日历
    print("=" * 50)
    print("获取交易日历")
    print("=" * 50)
    calendar = D.calendar(start_time='2020-01-01', end_time='2020-12-31')
    print(f"2020年交易日数量: {len(calendar)}")
    print(f"第一个交易日: {calendar[0]}")
    print(f"最后一个交易日: {calendar[-1]}\n")

    # 3. 获取股票池
    print("=" * 50)
    print("获取股票池")
    print("=" * 50)
    instruments = D.instruments(market='csi300')
    print(f"CSI300 股票数量: {len(instruments)}")
    print(f"前5只股票: {list(instruments)[:5]}\n")

    # 4. 获取特征数据
    print("=" * 50)
    print("获取特征数据")
    print("=" * 50)
    sample_stocks = list(instruments)[:3]  # 取前3只股票
    data = D.features(
        instruments=sample_stocks,
        fields=['$close', '$volume'],
        start_time='2020-01-01',
        end_time='2020-01-10'
    )
    print(f"数据形状: {data.shape}")
    print(f"\n数据预览:\n{data.head(10)}")

    print("\n" + "=" * 50)
    print("✅ 基础使用示例完成！")
    print("=" * 50)

if __name__ == '__main__':
    main()
```

## 八、常见问题

### 问题1：初始化失败

**错误信息**：
```
FileNotFoundError: Data directory not found
```

**解决方案**：
1. 检查数据路径是否正确
2. 确认数据是否已下载（参考 [02-数据准备.md](02-数据准备.md)）
3. 使用绝对路径而不是相对路径

### 问题2：查询不到数据

**错误信息**：
```
Empty DataFrame
```

**解决方案**：
1. 检查日期范围是否在数据范围内
2. 确认股票代码是否正确
3. 检查股票池是否包含目标股票

### 问题3：字段不存在

**错误信息**：
```
KeyError: '$xxx'
```

**解决方案**：
1. 检查字段名是否正确（注意 `$` 前缀）
2. 确认数据中是否包含该字段
3. 参考 Qlib 文档查看可用字段列表

## 九、数据查询技巧

### 1. 使用切片减少数据量

```python
# 只查询部分股票
instruments = D.instruments(market='csi300')
sample_stocks = list(instruments)[:10]  # 只取前10只
```

### 2. 分时间段查询大数据量

```python
# 如果数据量很大，可以分时间段查询
for year in range(2020, 2023):
    start = f'{year}-01-01'
    end = f'{year}-12-31'
    data = D.features(instruments, fields, start_time=start, end_time=end)
    # 处理数据...
```

### 3. 缓存查询结果

```python
import pandas as pd

# 将查询结果保存为 CSV
data = D.features(...)
data.to_csv('data_cache.csv')

# 下次直接读取
data = pd.read_csv('data_cache.csv', index_col=[0, 1])
```

## 十、下一步

掌握基础使用后，请继续阅读：
- **[04-特征工程.md](04-特征工程.md)** - 学习特征提取和 Alpha158 特征库

## 十一、基础使用检查清单

在继续之前，请确认：

- [ ] 能够成功初始化 Qlib（A 股或美股）
- [ ] 能够获取交易日历
- [ ] 能够获取股票池
- [ ] 能够查询特征数据
- [ ] 理解数据的基本结构（MultiIndex）

如果所有项目都已完成，您已经掌握了 Qlib 的基础使用方法！
