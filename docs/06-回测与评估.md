# 06-回测与评估

本文档详细介绍如何在 Qlib 中进行策略回测和绩效评估。

## 一、回测概述

回测是量化投资中验证策略有效性的重要环节。Qlib 提供了完整的回测框架，可以模拟真实交易环境，计算各种绩效指标。

### 回测的基本流程

1. **生成预测信号**：使用训练好的模型生成股票预测分数
2. **执行选股策略**：根据预测分数选择股票
3. **模拟交易**：按照策略规则进行买卖操作
4. **计算绩效指标**：计算收益率、最大回撤、夏普比率等

## 二、回测配置

### 基本回测配置

```python
backtest_config = {
    'start_time': '2017-01-01',      # 回测开始时间
    'end_time': '2020-12-31',         # 回测结束时间
    'account': 100000000,              # 初始资金（1亿）
    'benchmark': 'SH000300',           # 基准指数（沪深300）
    'exchange_kwargs': {
        'limit_threshold': 0.095,      # 涨跌停限制（9.5%）
        'deal_price': 'close',         # 成交价格（收盘价）
        'open_cost': 0.0005,           # 买入佣金（0.05%）
        'close_cost': 0.0015,          # 卖出佣金（0.15%）
        'min_cost': 5                   # 最小佣金（5元）
    }
}
```

### 参数说明

#### 时间参数
- **start_time**：回测开始日期
- **end_time**：回测结束日期

#### 资金参数
- **account**：初始资金，单位：元

#### 基准参数
- **benchmark**：基准指数代码
  - A股：`SH000300`（沪深300）、`SH000905`（中证500）等
  - 美股：`^GSPC`（标普500）等

#### 交易参数
- **limit_threshold**：涨跌停限制，A股通常为 0.095（9.5%）
- **deal_price**：成交价格，可选 `close`（收盘价）、`open`（开盘价）等
- **open_cost**：买入佣金率
- **close_cost**：卖出佣金率
- **min_cost**：最小佣金金额

## 三、选股策略配置

### TopkDropoutStrategy 策略

```python
strategy_config = {
    'class': 'TopkDropoutStrategy',
    'module_path': 'qlib.contrib.strategy.strategy',
    'kwargs': {
        'topk': 50,                    # 持仓股票数量
        'n_drop': 5,                   # 每次调仓最少更换股票数
        'signal': '<PRED>'             # 预测信号（占位符）
    }
}
```

### 策略参数说明

- **topk**：持仓股票数量，例如 50 表示持有 50 只股票
- **n_drop**：每次调仓时最少更换的股票数量，用于控制换手率
- **signal**：预测信号，`<PRED>` 是占位符，实际运行时会被替换为模型预测结果

## 四、执行回测

### 使用 PortAnaRecord 进行回测

```python
from qlib.workflow.record_temp import PortAnaRecord
from qlib.contrib.strategy.strategy import TopkDropoutStrategy
from qlib.backtest import backtest

# 1. 准备预测信号（假设已有模型预测结果）
pred = model.predict(test_data)  # 预测结果

# 2. 配置策略
strategy = TopkDropoutStrategy(
    topk=50,
    n_drop=5,
    signal=pred
)

# 3. 配置回测参数
backtest_config = {
    'start_time': '2017-01-01',
    'end_time': '2020-12-31',
    'account': 100000000,
    'benchmark': 'SH000300',
    'exchange_kwargs': {
        'limit_threshold': 0.095,
        'deal_price': 'close',
        'open_cost': 0.0005,
        'close_cost': 0.0015,
        'min_cost': 5
    }
}

# 4. 执行回测
port_analysis_config = {
    'strategy': strategy,
    'backtest': backtest_config
}

record = PortAnaRecord(**port_analysis_config)
record.generate()
```

## 五、绩效指标解读

### 主要绩效指标

#### 1. 年化收益率（Annualized Return）

```python
# 年化收益率 = (最终净值 / 初始净值) ^ (1 / 年数) - 1
annualized_return = ...
```

**解读**：
- 正值表示盈利，负值表示亏损
- 通常与基准指数对比，看是否跑赢基准

#### 2. 信息比率（Information Ratio, IR）

```python
# IR = 超额收益 / 跟踪误差
information_ratio = ...
```

**解读**：
- IR > 0 表示策略有效
- IR 越高，策略表现越好
- 通常 IR > 1 被认为是较好的策略

#### 3. 最大回撤（Max Drawdown）

```python
# 最大回撤 = 最大净值回撤幅度
max_drawdown = ...
```

**解读**：
- 负值，绝对值越小越好
- 表示策略可能面临的最大亏损
- 是风险管理的重要指标

#### 4. 夏普比率（Sharpe Ratio）

```python
# 夏普比率 = (收益率 - 无风险利率) / 收益率标准差
sharpe_ratio = ...
```

**解读**：
- 衡量风险调整后的收益
- 通常 > 1 被认为是较好的策略
- 越高表示单位风险的收益越高

#### 5. 胜率（Win Rate）

```python
# 胜率 = 盈利交易次数 / 总交易次数
win_rate = ...
```

**解读**：
- 0-1 之间的值，越高越好
- 表示策略的稳定性

### 查看回测结果

```python
# 获取回测报告
report = record.load()
print(report)

# 查看具体指标
print(f"年化收益率: {report['return']:.2%}")
print(f"信息比率: {report['information_ratio']:.4f}")
print(f"最大回撤: {report['max_drawdown']:.2%}")
print(f"夏普比率: {report['sharpe_ratio']:.4f}")
```

## 六、完整回测示例

```python
#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
回测与评估完整示例
"""

import qlib
from qlib.constant import REG_CN
from qlib.contrib.model.gbdt import LGBModel
from qlib.data.dataset import DatasetH
from qlib.contrib.data.handler import Alpha158
from qlib.contrib.strategy.strategy import TopkDropoutStrategy
from qlib.workflow.record_temp import PortAnaRecord

def main():
    # 初始化 Qlib
    print("正在初始化 Qlib...")
    qlib.init(provider_uri='~/.qlib/qlib_data/cn_data', region=REG_CN)
    print("✅ Qlib 初始化成功\n")

    # 1. 准备数据和模型
    print("=" * 50)
    print("准备数据和模型")
    print("=" * 50)

    handler = Alpha158(
        start_time='2008-01-01',
        end_time='2020-12-31',
        fit_start_time='2008-01-01',
        fit_end_time='2020-12-31',
        instruments='csi300'
    )

    dataset = DatasetH(
        handler=handler,
        segments={
            'train': ('2008-01-01', '2014-12-31'),
            'valid': ('2015-01-01', '2016-12-31'),
            'test': ('2017-01-01', '2020-12-31')
        }
    )

    # 训练模型（简化版，实际应该先训练）
    model = LGBModel(loss='mse', learning_rate=0.05, num_leaves=31)
    model.fit(dataset)

    # 获取测试集预测
    test_data = dataset.prepare('test')
    pred = model.predict(test_data)

    print(f"预测信号形状: {pred.shape}")

    # 2. 配置回测
    print("\n" + "=" * 50)
    print("配置回测")
    print("=" * 50)

    strategy_config = {
        'class': 'TopkDropoutStrategy',
        'module_path': 'qlib.contrib.strategy.strategy',
        'kwargs': {
            'topk': 50,
            'n_drop': 5,
            'signal': pred
        }
    }

    backtest_config = {
        'start_time': '2017-01-01',
        'end_time': '2020-12-31',
        'account': 100000000,
        'benchmark': 'SH000300',
        'exchange_kwargs': {
            'limit_threshold': 0.095,
            'deal_price': 'close',
            'open_cost': 0.0005,
            'close_cost': 0.0015,
            'min_cost': 5
        }
    }

    port_analysis_config = {
        'strategy': strategy_config,
        'backtest': backtest_config
    }

    # 3. 执行回测
    print("\n" + "=" * 50)
    print("执行回测")
    print("=" * 50)

    record = PortAnaRecord(**port_analysis_config)
    record.generate()

    # 4. 查看结果
    print("\n" + "=" * 50)
    print("回测结果")
    print("=" * 50)

    report = record.load()
    print(f"年化收益率: {report.get('return', 'N/A'):.2%}")
    print(f"信息比率: {report.get('information_ratio', 'N/A'):.4f}")
    print(f"最大回撤: {report.get('max_drawdown', 'N/A'):.2%}")

    print("\n" + "=" * 50)
    print("✅ 回测示例完成！")
    print("=" * 50)

if __name__ == '__main__':
    main()
```

## 七、回测结果分析

### 净值曲线

```python
# 获取净值曲线数据
# 通常回测结果中会包含净值曲线数据
# 可以用于绘制图表分析
```

### 持仓分析

```python
# 分析持仓情况
# 查看每个时间点的持仓股票
# 分析换手率、持仓集中度等
```

### 交易分析

```python
# 分析交易记录
# 查看买卖时机
# 分析交易成本对收益的影响
```

## 八、常见问题

### 问题1：回测结果异常

**可能原因**：
1. 使用了未来信息
2. 数据质量问题
3. 策略配置错误

**解决方案**：
1. 检查特征是否包含未来信息
2. 检查数据时间范围
3. 验证策略配置是否正确

### 问题2：回测速度慢

**解决方案**：
1. 减少回测时间范围
2. 减少股票数量
3. 优化策略逻辑

### 问题3：绩效指标异常

**解决方案**：
1. 检查初始资金设置
2. 检查佣金设置是否合理
3. 检查基准指数是否正确

## 九、回测最佳实践

1. **避免未来信息**：确保不使用未来数据
2. **合理设置成本**：考虑真实的交易成本
3. **多时间段验证**：在不同时间段进行回测
4. **对比基准**：与基准指数对比评估
5. **风险控制**：关注最大回撤等风险指标

## 十、下一步

掌握回测与评估后，请继续阅读：
- **[07-选股策略.md](07-选股策略.md)** - 深入了解选股策略的细节

## 十一、回测检查清单

在继续之前，请确认：

- [ ] 理解回测的基本流程
- [ ] 能够配置回测参数
- [ ] 能够执行回测
- [ ] 能够解读绩效指标
- [ ] 理解各种指标的含义

如果所有项目都已完成，您已经掌握了 Qlib 中的回测与评估方法！
