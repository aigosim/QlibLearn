# 07-选股策略

本文档详细介绍 Qlib 中的选股策略，重点讲解 TopkDropoutStrategy 的工作原理和使用方法。

## 一、选股策略概述

选股策略是量化投资的核心，决定了如何从股票池中选择投资标的。Qlib 提供了多种选股策略，其中最常用的是 TopkDropoutStrategy。

### 选股策略的基本流程

1. **获取预测信号**：使用模型对股票进行预测打分
2. **排序选股**：根据预测分数对股票进行排序
3. **确定持仓**：选择排名靠前的股票作为持仓
4. **动态调仓**：定期根据新的预测结果调整持仓

## 二、TopkDropoutStrategy 详解

TopkDropoutStrategy 是 Qlib 中最常用的选股策略，其核心思想是：
- 每日选择预测分数最高的 K 只股票
- 如果持仓中的股票排名下降，则进行换仓
- 通过 n_drop 参数控制换仓频率

### 策略工作原理

#### 1. 初始选股

```python
# 假设有 300 只股票，预测分数如下：
# 股票A: 0.15 (最高)
# 股票B: 0.12
# 股票C: 0.10
# ...
# 股票Z: -0.05 (最低)

# 如果 topk=50，则选择分数最高的 50 只股票
# 持仓: [股票A, 股票B, 股票C, ..., 第50只股票]
```

#### 2. 动态调仓

```python
# 第二天，新的预测分数：
# 股票A: 0.08 (排名下降)
# 股票B: 0.14 (排名上升)
# 股票C: 0.11
# ...
# 股票Y: 0.12 (新进入前50)

# 如果股票A排名跌出前50，且 n_drop=5
# 则至少更换 5 只股票：
# 卖出: 股票A 等排名下降的股票
# 买入: 股票Y 等排名上升的股票
```

### 策略参数

#### topk - 持仓数量

```python
topk = 50  # 持有 50 只股票
```

**说明**：
- 控制持仓股票数量
- 数量越多，分散度越高，但可能降低收益
- 数量越少，集中度越高，风险也越高

**选择建议**：
- 小资金（< 1000万）：10-30 只
- 中等资金（1000万-1亿）：30-50 只
- 大资金（> 1亿）：50-100 只

#### n_drop - 最少换仓数量

```python
n_drop = 5  # 每次调仓至少更换 5 只股票
```

**说明**：
- 控制换仓频率
- 值越大，换仓越频繁，交易成本越高
- 值越小，换仓越少，但可能错过机会

**选择建议**：
- 高频策略：n_drop = topk * 0.2（20%换仓率）
- 中频策略：n_drop = topk * 0.1（10%换仓率）
- 低频策略：n_drop = topk * 0.05（5%换仓率）

### 策略配置示例

```python
from qlib.contrib.strategy.strategy import TopkDropoutStrategy

# 配置策略
strategy = TopkDropoutStrategy(
    topk=50,           # 持仓 50 只股票
    n_drop=5,          # 每次至少换 5 只
    signal=pred        # 预测信号（模型预测结果）
)
```

## 三、策略使用流程

### 完整使用流程

```python
# 1. 准备预测信号
pred = model.predict(test_data)

# 2. 创建策略
strategy = TopkDropoutStrategy(
    topk=50,
    n_drop=5,
    signal=pred
)

# 3. 配置回测参数
backtest_config = {
    'start_time': '2017-01-01',
    'end_time': '2020-12-31',
    'account': 100000000,
    'benchmark': 'SH000300',
    'exchange_kwargs': {
        'limit_threshold': 0.095,
        'deal_price': 'close',
        'open_cost': 0.0005,
        'close_cost': 0.0015,
        'min_cost': 5
    }
}

# 4. 执行回测
from qlib.workflow.record_temp import PortAnaRecord

port_analysis_config = {
    'strategy': {
        'class': 'TopkDropoutStrategy',
        'module_path': 'qlib.contrib.strategy.strategy',
        'kwargs': {
            'topk': 50,
            'n_drop': 5,
            'signal': pred
        }
    },
    'backtest': backtest_config
}

record = PortAnaRecord(**port_analysis_config)
record.generate()
```

## 四、策略调优

### 参数调优

#### 1. topk 调优

```python
# 测试不同的 topk 值
topk_values = [20, 30, 50, 70, 100]

results = {}
for topk in topk_values:
    strategy = TopkDropoutStrategy(
        topk=topk,
        n_drop=topk // 10,  # n_drop 随 topk 调整
        signal=pred
    )

    # 执行回测并记录结果
    # ...
    results[topk] = performance_metrics
```

#### 2. n_drop 调优

```python
# 测试不同的 n_drop 值
n_drop_values = [3, 5, 7, 10, 15]

results = {}
for n_drop in n_drop_values:
    strategy = TopkDropoutStrategy(
        topk=50,
        n_drop=n_drop,
        signal=pred
    )

    # 执行回测并记录结果
    # ...
    results[n_drop] = performance_metrics
```

### 策略组合

可以组合多个策略或使用多个模型：

```python
# 使用多个模型的预测结果
pred1 = model1.predict(test_data)
pred2 = model2.predict(test_data)

# 组合预测（简单平均）
pred_combined = (pred1 + pred2) / 2

# 使用组合预测进行选股
strategy = TopkDropoutStrategy(
    topk=50,
    n_drop=5,
    signal=pred_combined
)
```

## 五、其他选股策略

### WeightStrategy - 权重策略

```python
from qlib.contrib.strategy.strategy import WeightStrategy

# 根据预测分数分配权重
strategy = WeightStrategy(
    signal=pred,
    topk=50
)
```

### EnhancedIndexingStrategy - 指数增强策略

```python
from qlib.contrib.strategy.strategy import EnhancedIndexingStrategy

# 在跟踪指数的同时获取超额收益
strategy = EnhancedIndexingStrategy(
    signal=pred,
    topk=50
)
```

## 六、策略评估指标

### 选股效果评估

```python
# 1. 预测准确性
# 计算预测分数与实际收益的相关性
ic = pred.corr(label)  # IC 值

# 2. 选股收益
# 计算选中股票的平均收益
selected_stocks_returns = ...

# 3. 换手率
# 计算策略的换手率
turnover_rate = ...
```

### 策略表现评估

```python
# 回测后的绩效指标
report = record.load()

# 关键指标
annualized_return = report['return']      # 年化收益
information_ratio = report['information_ratio']  # 信息比率
max_drawdown = report['max_drawdown']     # 最大回撤
sharpe_ratio = report['sharpe_ratio']     # 夏普比率
```

## 七、策略优化建议

### 1. 避免过度交易

```python
# 设置合理的 n_drop，避免频繁换仓
# 考虑交易成本
n_drop = max(1, int(topk * 0.1))  # 10% 换仓率
```

### 2. 考虑市场环境

```python
# 根据市场波动调整策略参数
# 高波动市场：减少 topk，增加 n_drop
# 低波动市场：增加 topk，减少 n_drop
```

### 3. 风险控制

```python
# 设置止损机制
# 设置单只股票最大仓位
# 设置行业集中度限制
```

## 八、完整示例

```python
#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
选股策略完整示例
"""

import qlib
from qlib.constant import REG_CN
from qlib.contrib.model.gbdt import LGBModel
from qlib.data.dataset import DatasetH
from qlib.contrib.data.handler import Alpha158
from qlib.contrib.strategy.strategy import TopkDropoutStrategy
from qlib.workflow.record_temp import PortAnaRecord

def main():
    # 初始化 Qlib
    qlib.init(provider_uri='~/.qlib/qlib_data/cn_data', region=REG_CN)

    # 准备数据和模型
    handler = Alpha158(
        start_time='2008-01-01',
        end_time='2020-12-31',
        fit_start_time='2008-01-01',
        fit_end_time='2020-12-31',
        instruments='csi300'
    )

    dataset = DatasetH(
        handler=handler,
        segments={
            'train': ('2008-01-01', '2014-12-31'),
            'test': ('2017-01-01', '2020-12-31')
        }
    )

    # 训练模型
    model = LGBModel(loss='mse', learning_rate=0.05)
    model.fit(dataset)

    # 获取预测
    test_data = dataset.prepare('test')
    pred = model.predict(test_data)

    # 配置选股策略
    strategy_config = {
        'class': 'TopkDropoutStrategy',
        'module_path': 'qlib.contrib.strategy.strategy',
        'kwargs': {
            'topk': 50,
            'n_drop': 5,
            'signal': pred
        }
    }

    # 配置回测
    backtest_config = {
        'start_time': '2017-01-01',
        'end_time': '2020-12-31',
        'account': 100000000,
        'benchmark': 'SH000300',
        'exchange_kwargs': {
            'limit_threshold': 0.095,
            'deal_price': 'close',
            'open_cost': 0.0005,
            'close_cost': 0.0015,
            'min_cost': 5
        }
    }

    # 执行回测
    port_analysis_config = {
        'strategy': strategy_config,
        'backtest': backtest_config
    }

    record = PortAnaRecord(**port_analysis_config)
    record.generate()

    # 查看结果
    report = record.load()
    print(f"年化收益率: {report.get('return', 'N/A'):.2%}")
    print(f"信息比率: {report.get('information_ratio', 'N/A'):.4f}")

if __name__ == '__main__':
    main()
```

## 九、常见问题

### 问题1：选股数量如何确定？

**建议**：
- 根据资金规模确定
- 考虑分散度要求
- 通过回测验证不同 topk 值的效果

### 问题2：换仓频率如何控制？

**建议**：
- 考虑交易成本
- 考虑预测信号的稳定性
- 通过回测找到最优 n_drop

### 问题3：策略表现不佳

**可能原因**：
1. 预测信号质量差
2. 参数设置不合理
3. 市场环境变化

**解决方案**：
1. 改进模型和特征
2. 调整策略参数
3. 考虑市场环境因素

## 十、下一步

掌握选股策略后，请继续阅读：
- **[08-命令行选股工具.md](08-命令行选股工具.md)** - 学习如何使用命令行选股工具

## 十一、选股策略检查清单

在继续之前，请确认：

- [ ] 理解 TopkDropoutStrategy 的工作原理
- [ ] 能够配置策略参数
- [ ] 能够执行选股策略
- [ ] 理解策略评估指标
- [ ] 能够进行策略调优

如果所有项目都已完成，您已经掌握了 Qlib 中的选股策略！
