# 05-模型训练

本文档详细介绍如何使用 LightGBM 模型在 Qlib 中进行模型训练。

## 一、LightGBM 模型概述

LightGBM 是一个基于梯度提升决策树（GBDT）的机器学习框架，在量化投资领域应用广泛，特别适合处理表格型数据。

### LightGBM 的优势

1. **训练速度快**：相比传统 GBDT 算法，训练速度更快
2. **内存占用低**：使用直方图算法，内存占用更少
3. **准确率高**：在大多数任务上表现优异
4. **支持并行**：支持多线程并行训练

## 二、准备数据集

在训练模型之前，需要准备数据集。

### 使用 Alpha158 创建数据集

```python
from qlib.data.dataset import DatasetH
from qlib.contrib.data.handler import Alpha158

# 创建数据处理器
handler = Alpha158(
    start_time='2008-01-01',
    end_time='2020-12-31',
    fit_start_time='2008-01-01',
    fit_end_time='2020-12-31',
    instruments='csi300'
)

# 创建数据集，划分训练/验证/测试集
dataset = DatasetH(
    handler=handler,
    segments={
        'train': ('2008-01-01', '2014-12-31'),
        'valid': ('2015-01-01', '2016-12-31'),
        'test': ('2017-01-01', '2020-12-31')
    }
)
```

### 数据集划分原则

1. **训练集**：用于模型训练，通常占 60-70% 的时间范围
2. **验证集**：用于调参和早停，通常占 15-20% 的时间范围
3. **测试集**：用于最终评估，通常占 15-20% 的时间范围

**重要**：必须按时间顺序划分，不能随机划分，避免使用未来信息。

## 三、创建 LightGBM 模型

### 基本用法

```python
from qlib.contrib.model.gbdt import LGBModel

# 创建 LightGBM 模型
model = LGBModel(
    loss='mse',                    # 损失函数：均方误差
    colsample_bytree=0.8879,       # 特征采样比例
    learning_rate=0.0421,          # 学习率
    subsample=0.8789,              # 样本采样比例
    lambda_l1=205.6999,            # L1 正则化
    lambda_l2=580.9768,            # L2 正则化
    max_depth=8,                   # 树的最大深度
    num_leaves=210,                # 叶子节点数
    num_threads=20                 # 线程数
)
```

### 模型参数说明

#### 核心参数

- **loss**：损失函数，常用 `mse`（回归）或 `binary`（二分类）
- **learning_rate**：学习率，控制每棵树的贡献，通常 0.01-0.1
- **num_leaves**：叶子节点数，控制模型复杂度
- **max_depth**：树的最大深度，限制模型复杂度

#### 正则化参数

- **lambda_l1**：L1 正则化系数，防止过拟合
- **lambda_l2**：L2 正则化系数，防止过拟合
- **min_data_in_leaf**：叶子节点最小样本数

#### 采样参数

- **subsample**：样本采样比例，防止过拟合
- **colsample_bytree**：特征采样比例，增加随机性

#### 其他参数

- **num_threads**：并行线程数
- **n_estimators**：树的数量（如果使用早停，可以设置较大值）

## 四、模型训练

### 基本训练流程

```python
from qlib.contrib.model.gbdt import LGBModel
from qlib.data.dataset import DatasetH
from qlib.contrib.data.handler import Alpha158

# 1. 准备数据集
handler = Alpha158(
    start_time='2008-01-01',
    end_time='2020-12-31',
    fit_start_time='2008-01-01',
    fit_end_time='2020-12-31',
    instruments='csi300'
)

dataset = DatasetH(
    handler=handler,
    segments={
        'train': ('2008-01-01', '2014-12-31'),
        'valid': ('2015-01-01', '2016-12-31'),
        'test': ('2017-01-01', '2020-12-31')
    }
)

# 2. 创建模型
model = LGBModel(
    loss='mse',
    learning_rate=0.05,
    num_leaves=31,
    max_depth=5,
    num_threads=20
)

# 3. 训练模型
print("开始训练模型...")
model.fit(dataset)
print("模型训练完成！")
```

### 训练过程监控

```python
# 训练时会输出训练进度
# 如果设置了验证集，会显示验证集上的损失
model.fit(dataset)

# 训练完成后，可以查看模型信息
print(f"模型类型: {type(model)}")
print(f"模型参数: {model.get_params()}")
```

## 五、模型预测

### 在测试集上预测

```python
# 获取测试集
test_data = dataset.prepare('test')

# 进行预测
pred = model.predict(test_data)
print(f"预测结果形状: {pred.shape}")
print(f"预测结果预览:\n{pred.head()}")
```

### 预测结果说明

预测结果是一个 pandas Series，索引为 (instrument, datetime)，值为预测的收益率或分数。

```python
# 预测结果示例
# instrument  datetime
# SH000001    2017-01-03    0.0123
#             2017-01-04    0.0045
# ...
```

## 六、模型评估

### 计算 IC 值（信息系数）

IC（Information Coefficient）衡量预测值与真实值的相关性。

```python
from qlib.contrib.evaluate import risk_analysis

# 获取真实标签
test_data = dataset.prepare('test')
label = test_data['label']

# 获取预测值
pred = model.predict(test_data)

# 计算 IC 值
ic = risk_analysis(pred, label)
print(f"IC 值: {ic}")
```

### 计算其他指标

```python
import pandas as pd
import numpy as np

# 合并预测值和真实值
result = pd.DataFrame({
    'pred': pred,
    'label': label
})

# 计算相关系数
correlation = result['pred'].corr(result['label'])
print(f"相关系数: {correlation}")

# 计算 RMSE
rmse = np.sqrt(np.mean((result['pred'] - result['label'])**2))
print(f"RMSE: {rmse}")
```

## 七、模型保存与加载

### 保存模型

```python
import pickle

# 保存模型
with open('lgb_model.pkl', 'wb') as f:
    pickle.dump(model, f)

print("模型已保存到 lgb_model.pkl")
```

### 加载模型

```python
import pickle

# 加载模型
with open('lgb_model.pkl', 'rb') as f:
    loaded_model = pickle.load(f)

print("模型加载成功")
```

## 八、超参数调优

### 网格搜索

```python
from qlib.contrib.model.gbdt import LGBModel

# 定义参数网格
param_grid = {
    'learning_rate': [0.01, 0.05, 0.1],
    'num_leaves': [31, 63, 127],
    'max_depth': [5, 7, 9]
}

best_score = -np.inf
best_params = None

# 网格搜索
for lr in param_grid['learning_rate']:
    for num_leaves in param_grid['num_leaves']:
        for max_depth in param_grid['max_depth']:
            # 创建模型
            model = LGBModel(
                loss='mse',
                learning_rate=lr,
                num_leaves=num_leaves,
                max_depth=max_depth
            )

            # 训练模型
            model.fit(dataset)

            # 评估模型（在验证集上）
            valid_data = dataset.prepare('valid')
            pred = model.predict(valid_data)
            label = valid_data['label']

            # 计算 IC
            ic = pred.corr(label)

            # 更新最佳参数
            if ic > best_score:
                best_score = ic
                best_params = {
                    'learning_rate': lr,
                    'num_leaves': num_leaves,
                    'max_depth': max_depth
                }

            print(f"参数: lr={lr}, num_leaves={num_leaves}, max_depth={max_depth}, IC={ic:.4f}")

print(f"\n最佳参数: {best_params}")
print(f"最佳 IC: {best_score:.4f}")
```

## 九、完整训练示例

```python
#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
LightGBM 模型训练完整示例
"""

import qlib
from qlib.constant import REG_CN
from qlib.contrib.model.gbdt import LGBModel
from qlib.data.dataset import DatasetH
from qlib.contrib.data.handler import Alpha158
import numpy as np
import pandas as pd

def main():
    # 初始化 Qlib
    print("正在初始化 Qlib...")
    qlib.init(provider_uri='~/.qlib/qlib_data/cn_data', region=REG_CN)
    print("✅ Qlib 初始化成功\n")

    # 1. 准备数据集
    print("=" * 50)
    print("准备数据集")
    print("=" * 50)

    handler = Alpha158(
        start_time='2008-01-01',
        end_time='2020-12-31',
        fit_start_time='2008-01-01',
        fit_end_time='2020-12-31',
        instruments='csi300'
    )

    dataset = DatasetH(
        handler=handler,
        segments={
            'train': ('2008-01-01', '2014-12-31'),
            'valid': ('2015-01-01', '2016-12-31'),
            'test': ('2017-01-01', '2020-12-31')
        }
    )

    # 查看数据集信息
    train_data = dataset.prepare('train')
    valid_data = dataset.prepare('valid')
    test_data = dataset.prepare('test')

    print(f"训练集形状: {train_data.shape}")
    print(f"验证集形状: {valid_data.shape}")
    print(f"测试集形状: {test_data.shape}")

    # 2. 创建模型
    print("\n" + "=" * 50)
    print("创建 LightGBM 模型")
    print("=" * 50)

    model = LGBModel(
        loss='mse',
        learning_rate=0.05,
        num_leaves=31,
        max_depth=5,
        num_threads=20
    )

    print("模型创建成功")

    # 3. 训练模型
    print("\n" + "=" * 50)
    print("开始训练模型")
    print("=" * 50)

    model.fit(dataset)
    print("✅ 模型训练完成")

    # 4. 模型预测
    print("\n" + "=" * 50)
    print("模型预测")
    print("=" * 50)

    pred = model.predict(test_data)
    print(f"预测结果形状: {pred.shape}")
    print(f"预测结果预览:\n{pred.head()}")

    # 5. 模型评估
    print("\n" + "=" * 50)
    print("模型评估")
    print("=" * 50)

    label = test_data['label']
    correlation = pred.corr(label)
    rmse = np.sqrt(np.mean((pred - label)**2))

    print(f"预测值与真实值的相关系数: {correlation:.4f}")
    print(f"RMSE: {rmse:.4f}")

    print("\n" + "=" * 50)
    print("✅ 模型训练示例完成！")
    print("=" * 50)

if __name__ == '__main__':
    main()
```

## 十、常见问题

### 问题1：训练时间过长

**解决方案**：
1. 减少训练数据量（减少时间范围或股票数量）
2. 减少模型复杂度（减少 num_leaves 和 max_depth）
3. 增加 num_threads 使用多线程
4. 使用早停机制

### 问题2：过拟合

**解决方案**：
1. 增加正则化参数（lambda_l1, lambda_l2）
2. 增加采样比例（subsample, colsample_bytree）
3. 减少模型复杂度
4. 增加训练数据量

### 问题3：内存不足

**解决方案**：
1. 减少训练数据量
2. 减少特征数量
3. 使用数据分批处理

### 问题4：预测结果异常

**解决方案**：
1. 检查数据是否有异常值
2. 检查特征是否包含未来信息
3. 检查模型是否过拟合

## 十一、模型训练最佳实践

1. **数据划分**：严格按时间顺序划分，避免数据泄露
2. **参数初始化**：从简单参数开始，逐步调优
3. **早停机制**：使用验证集进行早停，防止过拟合
4. **交叉验证**：使用时间序列交叉验证评估模型
5. **模型集成**：可以训练多个模型进行集成

## 十二、下一步

掌握模型训练后，请继续阅读：
- **[06-回测与评估.md](06-回测与评估.md)** - 学习如何进行策略回测和绩效评估

## 十三、模型训练检查清单

在继续之前，请确认：

- [ ] 能够创建和准备数据集
- [ ] 能够创建 LightGBM 模型
- [ ] 能够训练模型
- [ ] 能够进行预测和评估
- [ ] 理解模型参数的含义

如果所有项目都已完成，您已经掌握了 Qlib 中的模型训练方法！
