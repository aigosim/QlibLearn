# 08-命令行选股工具

本文档介绍如何使用命令行选股工具，包括基础版本和增强版本的使用方法。

## 一、工具概述

本项目提供了两个版本的命令行选股工具：

1. **基础版本** (`06_stock_selection_cli_basic.py`)：简单的因子筛选选股
2. **增强版本** (`06_stock_selection_cli_advanced.py`)：包含模型预测和回测评估的完整选股工具

## 二、基础版本使用

### 功能说明

基础版本提供简单的因子筛选功能，根据指定的因子条件选择股票。

### 基本用法

```bash
python examples/06_stock_selection_cli_basic.py \
    --provider_uri ~/.qlib/qlib_data/cn_data \
    --market csi300 \
    --start_date 2023-01-01 \
    --end_date 2023-12-31 \
    --topk 10
```

### 参数说明

- **--provider_uri**：数据路径，默认 `~/.qlib/qlib_data/cn_data`
- **--region**：市场区域，`cn` 或 `us`，默认 `cn`
- **--market**：股票池，A股可选 `csi300`, `csi500`, `all` 等，默认 `csi300`
- **--start_date**：开始日期，格式 `YYYY-MM-DD`，必需
- **--end_date**：结束日期，格式 `YYYY-MM-DD`，必需
- **--topk**：选择股票数量，默认 10

### 使用示例

#### 示例1：选择 A 股 CSI300 中的 Top 10 股票

```bash
python examples/06_stock_selection_cli_basic.py \
    --provider_uri ~/.qlib/qlib_data/cn_data \
    --region cn \
    --market csi300 \
    --start_date 2023-01-01 \
    --end_date 2023-12-31 \
    --topk 10
```

#### 示例2：选择美股 Top 20 股票

```bash
python examples/06_stock_selection_cli_basic.py \
    --provider_uri ~/.qlib/qlib_data/us_data \
    --region us \
    --market all \
    --start_date 2023-01-01 \
    --end_date 2023-12-31 \
    --topk 20
```

### 输出格式

基础版本输出纯文本格式的股票列表：

```
选股结果 (2023-01-01 至 2023-12-31)
========================================
排名  股票代码    因子值
1     SH000001   0.1234
2     SH000002   0.1156
3     SH000003   0.1098
...
```

## 三、增强版本使用

### 功能说明

增强版本提供完整的选股功能，包括：
- 模型训练（可选）
- 模型预测
- 选股策略执行
- 回测评估（可选）

### 基本用法

```bash
python examples/06_stock_selection_cli_advanced.py \
    --provider_uri ~/.qlib/qlib_data/cn_data \
    --market csi300 \
    --start_date 2023-01-01 \
    --end_date 2023-12-31 \
    --topk 10 \
    --train_start 2020-01-01 \
    --train_end 2022-12-31
```

### 参数说明

#### 必需参数

- **--start_date**：选股开始日期，格式 `YYYY-MM-DD`
- **--end_date**：选股结束日期，格式 `YYYY-MM-DD`

#### 可选参数

- **--provider_uri**：数据路径，默认 `~/.qlib/qlib_data/cn_data`
- **--region**：市场区域，`cn` 或 `us`，默认 `cn`
- **--market**：股票池，默认 `csi300`
- **--topk**：选择股票数量，默认 10
- **--train_start**：模型训练开始日期，默认 `None`（使用预训练模型）
- **--train_end**：模型训练结束日期，默认 `None`
- **--model_path**：预训练模型路径，默认 `None`
- **--enable_backtest**：是否启用回测，默认 `False`
- **--initial_capital**：回测初始资金，默认 100000000（1亿）

### 使用示例

#### 示例1：使用预训练模型选股

```bash
python examples/06_stock_selection_cli_advanced.py \
    --provider_uri ~/.qlib/qlib_data/cn_data \
    --market csi300 \
    --start_date 2023-01-01 \
    --end_date 2023-12-31 \
    --topk 10 \
    --model_path ./models/lgb_model.pkl
```

#### 示例2：训练模型并选股

```bash
python examples/06_stock_selection_cli_advanced.py \
    --provider_uri ~/.qlib/qlib_data/cn_data \
    --market csi300 \
    --start_date 2023-01-01 \
    --end_date 2023-12-31 \
    --topk 10 \
    --train_start 2020-01-01 \
    --train_end 2022-12-31
```

#### 示例3：选股并执行回测

```bash
python examples/06_stock_selection_cli_advanced.py \
    --provider_uri ~/.qlib/qlib_data/cn_data \
    --market csi300 \
    --start_date 2023-01-01 \
    --end_date 2023-12-31 \
    --topk 10 \
    --train_start 2020-01-01 \
    --train_end 2022-12-31 \
    --enable_backtest \
    --initial_capital 100000000
```

### 输出格式

增强版本输出更详细的信息：

```
模型训练中...
✅ 模型训练完成

开始选股 (2023-01-01 至 2023-12-31)
========================================
日期: 2023-01-03
排名  股票代码    预测分数
1     SH000001   0.1234
2     SH000002   0.1156
...

回测结果:
年化收益率: 15.23%
信息比率: 1.2345
最大回撤: -8.56%
```

## 四、工具对比

| 功能 | 基础版本 | 增强版本 |
|------|---------|---------|
| 因子筛选 | ✅ | ✅ |
| 模型预测 | ❌ | ✅ |
| 模型训练 | ❌ | ✅ |
| 回测评估 | ❌ | ✅ |
| 使用复杂度 | 简单 | 中等 |

## 五、使用建议

### 何时使用基础版本

- 快速筛选股票
- 不需要模型预测
- 只需要简单的因子筛选

### 何时使用增强版本

- 需要模型预测选股
- 需要回测评估策略
- 需要完整的选股流程

## 六、常见问题

### 问题1：找不到数据

**错误信息**：
```
FileNotFoundError: Data directory not found
```

**解决方案**：
1. 检查 `--provider_uri` 参数是否正确
2. 确认数据是否已下载（参考 [02-数据准备.md](02-数据准备.md)）

### 问题2：日期格式错误

**错误信息**：
```
ValueError: Invalid date format
```

**解决方案**：
- 确保日期格式为 `YYYY-MM-DD`
- 例如：`2023-01-01` 而不是 `2023/01/01`

### 问题3：模型文件不存在

**错误信息**：
```
FileNotFoundError: Model file not found
```

**解决方案**：
1. 检查 `--model_path` 参数是否正确
2. 或者使用 `--train_start` 和 `--train_end` 训练新模型

### 问题4：内存不足

**解决方案**：
1. 减少时间范围
2. 减少股票数量（使用较小的 market）
3. 减少 topk 值

## 七、高级用法

### 批量选股

可以编写脚本批量运行选股工具：

```bash
#!/bin/bash
# 批量选股脚本

for year in 2020 2021 2022 2023; do
    python examples/06_stock_selection_cli_advanced.py \
        --start_date ${year}-01-01 \
        --end_date ${year}-12-31 \
        --topk 10 \
        --train_start 2018-01-01 \
        --train_end 2019-12-31
done
```

### 结果保存

可以将输出保存到文件：

```bash
python examples/06_stock_selection_cli_advanced.py \
    --start_date 2023-01-01 \
    --end_date 2023-12-31 \
    --topk 10 > selection_result.txt
```

## 八、下一步

掌握命令行选股工具后，您可以：
- 在实际项目中使用这些工具
- 根据需求修改和扩展工具功能
- 参考 [09-常见问题.md](09-常见问题.md) 解决遇到的问题

## 九、工具使用检查清单

在开始使用之前，请确认：

- [ ] 已安装 Qlib 和相关依赖
- [ ] 已下载数据（A股或美股）
- [ ] 理解基础版本和增强版本的区别
- [ ] 知道如何设置命令行参数
- [ ] 能够解读输出结果

如果所有项目都已完成，您可以开始使用命令行选股工具了！
