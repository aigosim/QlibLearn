# 04-特征工程

本文档介绍 Qlib 中的特征工程，包括 Alpha158 特征库的使用和自定义特征的构建。

## 一、特征工程概述

特征工程是量化投资的核心环节，好的特征能够显著提升模型的预测能力。Qlib 提供了丰富的特征工程工具和预定义的特征库。

## 二、Alpha158 特征库

Alpha158 是 Qlib 内置的一个包含 158 个量化因子的特征库，涵盖了技术指标、价格动量、成交量等多个维度。

### Alpha158 特征分类

Alpha158 特征库包含以下类型的特征：

1. **价格相关特征**：开盘价、收盘价、最高价、最低价的各类变换
2. **成交量相关特征**：成交量、成交额及其变化率
3. **技术指标特征**：移动平均、RSI、MACD 等
4. **时间序列特征**：滞后特征、滚动统计特征
5. **截面特征**：行业、市值等截面信息

### 使用 Alpha158

#### 方法1：通过 DataHandler 使用

```python
from qlib.contrib.data.handler import Alpha158
from qlib.data import D

# 创建 Alpha158 数据处理器
handler = Alpha158(
    start_time='2020-01-01',
    end_time='2020-12-31',
    fit_start_time='2020-01-01',
    fit_end_time='2020-12-31',
    instruments='csi300'
)

# 获取处理后的数据
data = handler.fetch()
print(f"数据形状: {data.shape}")
print(f"特征数量: {data.shape[1]}")
```

#### 方法2：在 Dataset 中使用

```python
from qlib.data.dataset import DatasetH
from qlib.contrib.data.handler import Alpha158

# 创建数据集，使用 Alpha158 作为数据处理器
dataset = DatasetH(
    handler=Alpha158(
        start_time='2020-01-01',
        end_time='2020-12-31',
        fit_start_time='2020-01-01',
        fit_end_time='2020-12-31',
        instruments='csi300'
    ),
    segments={
        'train': ('2020-01-01', '2020-08-31'),
        'valid': ('2020-09-01', '2020-10-31'),
        'test': ('2020-11-01', '2020-12-31')
    }
)

# 获取训练集
train_data = dataset.prepare('train')
print(f"训练集形状: {train_data.shape}")
```

## 三、特征表达式语法

Qlib 支持使用表达式来构建特征，语法类似于 SQL 或 Excel 公式。

### 基础字段

```python
from qlib.data import D

# 基础字段（使用 $ 前缀）
fields = [
    '$close',    # 收盘价
    '$open',     # 开盘价
    '$high',     # 最高价
    '$low',      # 最低价
    '$volume',   # 成交量
]
```

### 常用函数

#### 1. Ref - 滞后/超前函数

```python
# Ref($close, 1) 表示前一天的收盘价
# Ref($close, -1) 表示后一天的收盘价（用于标签）
fields = [
    '$close',
    'Ref($close, 1)',      # 前1日收盘价
    'Ref($close, 5)',      # 前5日收盘价
]
```

#### 2. Mean - 移动平均

```python
# Mean($close, 5) 表示5日移动平均
fields = [
    '$close',
    'Mean($close, 5)',     # 5日均价
    'Mean($close, 20)',    # 20日均价
]
```

#### 3. Std - 标准差

```python
# Std($close, 5) 表示5日收盘价的标准差
fields = [
    '$close',
    'Std($close, 5)',      # 5日标准差
]
```

#### 4. 算术运算

```python
# 支持 +, -, *, / 等运算
fields = [
    '$close / Ref($close, 1) - 1',           # 日收益率
    '($close - Mean($close, 5)) / Std($close, 5)',  # 标准化
]
```

#### 5. 条件表达式

```python
# If(condition, true_value, false_value)
fields = [
    'If($close > Ref($close, 1), 1, 0)',    # 是否上涨
]
```

### 完整示例

```python
from qlib.data import D

instruments = D.instruments(market='csi300')
sample_stocks = list(instruments)[:10]

# 构建自定义特征
fields = [
    # 基础价格
    '$close',
    '$volume',

    # 收益率特征
    '$close / Ref($close, 1) - 1',          # 日收益率
    '$close / Ref($close, 5) - 1',           # 5日收益率

    # 移动平均特征
    'Mean($close, 5)',                      # 5日均价
    'Mean($close, 20)',                      # 20日均价

    # 价格位置特征
    '($close - Mean($close, 20)) / Mean($close, 20)',  # 价格相对位置

    # 波动率特征
    'Std($close, 5)',                       # 5日波动率

    # 成交量特征
    '$volume / Mean($volume, 5)',           # 成交量相对水平
]

data = D.features(
    instruments=sample_stocks,
    fields=fields,
    start_time='2020-01-01',
    end_time='2020-12-31'
)

print(data.head())
```

## 四、特征处理

### 数据标准化

```python
from qlib.contrib.data.handler import Alpha158
import numpy as np

# Alpha158 会自动进行标准化处理
handler = Alpha158(
    start_time='2020-01-01',
    end_time='2020-12-31',
    fit_start_time='2020-01-01',
    fit_end_time='2020-12-31',
    instruments='csi300'
)

data = handler.fetch()

# 查看数据统计信息
print(f"数据形状: {data.shape}")
print(f"均值: {data.mean()}")
print(f"标准差: {data.std()}")
```

### 缺失值处理

```python
# Qlib 会自动处理缺失值
# 可以通过参数控制处理方式
handler = Alpha158(
    start_time='2020-01-01',
    end_time='2020-12-31',
    fit_start_time='2020-01-01',
    fit_end_time='2020-12-31',
    instruments='csi300',
    # 缺失值处理方式
    dropna=True,  # 删除包含缺失值的行
)
```

## 五、自定义特征构建

### 创建自定义 DataHandler

```python
from qlib.contrib.data.handler import DataHandlerLP
from qlib.data import D

class CustomHandler(DataHandlerLP):
    """自定义数据处理器"""

    def __init__(self, **kwargs):
        super().__init__(**kwargs)

    def get_feature_config(self):
        """定义特征配置"""
        fields = [
            # 基础特征
            '$close',
            '$volume',

            # 自定义特征
            '$close / Ref($close, 1) - 1',           # 收益率
            'Mean($close, 5) / Mean($close, 20) - 1', # 均线比率
            'Std($close, 5)',                         # 波动率
        ]

        return fields, ['Ref($close, -1) / $close - 1']  # 特征和标签

# 使用自定义处理器
handler = CustomHandler(
    start_time='2020-01-01',
    end_time='2020-12-31',
    fit_start_time='2020-01-01',
    fit_end_time='2020-12-31',
    instruments='csi300'
)

data = handler.fetch()
print(f"自定义特征数据形状: {data.shape}")
```

## 六、特征选择

### 基于相关性的特征选择

```python
import pandas as pd
import numpy as np
from qlib.contrib.data.handler import Alpha158

# 获取数据
handler = Alpha158(
    start_time='2020-01-01',
    end_time='2020-12-31',
    fit_start_time='2020-01-01',
    fit_end_time='2020-12-31',
    instruments='csi300'
)

data = handler.fetch()

# 计算特征与标签的相关性
# 假设最后一列是标签
features = data.iloc[:, :-1]
label = data.iloc[:, -1]

# 计算相关性
correlations = features.corrwith(label).abs().sort_values(ascending=False)
print("特征重要性（相关性）:")
print(correlations.head(20))
```

## 七、完整示例

```python
#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
特征工程完整示例
"""

import qlib
from qlib.constant import REG_CN
from qlib.contrib.data.handler import Alpha158
from qlib.data.dataset import DatasetH

def main():
    # 初始化 Qlib
    qlib.init(provider_uri='~/.qlib/qlib_data/cn_data', region=REG_CN)

    # 1. 使用 Alpha158 特征库
    print("=" * 50)
    print("使用 Alpha158 特征库")
    print("=" * 50)

    handler = Alpha158(
        start_time='2020-01-01',
        end_time='2020-12-31',
        fit_start_time='2020-01-01',
        fit_end_time='2020-12-31',
        instruments='csi300'
    )

    data = handler.fetch()
    print(f"数据形状: {data.shape}")
    print(f"特征数量: {data.shape[1] - 1}")  # 减去标签列
    print(f"样本数量: {data.shape[0]}")
    print(f"\n前5个特征名: {list(data.columns[:5])}")

    # 2. 创建数据集
    print("\n" + "=" * 50)
    print("创建数据集")
    print("=" * 50)

    dataset = DatasetH(
        handler=handler,
        segments={
            'train': ('2020-01-01', '2020-08-31'),
            'valid': ('2020-09-01', '2020-10-31'),
            'test': ('2020-11-01', '2020-12-31')
        }
    )

    train_data = dataset.prepare('train')
    print(f"训练集形状: {train_data.shape}")
    print(f"训练集特征数: {train_data.shape[1] - 1}")

    print("\n" + "=" * 50)
    print("✅ 特征工程示例完成！")
    print("=" * 50)

if __name__ == '__main__':
    main()
```

## 八、常见问题

### 问题1：特征计算错误

**错误信息**：
```
SyntaxError in feature expression
```

**解决方案**：
1. 检查表达式语法是否正确
2. 确认字段名是否正确（注意大小写和 `$` 前缀）
3. 检查函数参数是否正确

### 问题2：数据维度不匹配

**错误信息**：
```
ValueError: shapes not aligned
```

**解决方案**：
1. 确保所有特征的时间范围一致
2. 检查是否有缺失值导致维度不一致
3. 确认数据对齐方式

### 问题3：特征数量过多导致内存不足

**解决方案**：
1. 减少股票数量或时间范围
2. 使用特征选择减少特征数量
3. 分批处理数据

## 九、特征工程最佳实践

1. **从简单开始**：先使用 Alpha158 等预定义特征库
2. **理解特征含义**：确保理解每个特征的经济含义
3. **特征选择**：使用相关性、重要性等方法选择有效特征
4. **避免过拟合**：不要使用未来信息构建特征
5. **特征标准化**：确保特征在合理范围内

## 十、下一步

掌握特征工程后，请继续阅读：
- **[05-模型训练.md](05-模型训练.md)** - 学习如何使用 LightGBM 进行模型训练

## 十一、特征工程检查清单

在继续之前，请确认：

- [ ] 理解 Alpha158 特征库的基本用法
- [ ] 能够使用特征表达式构建自定义特征
- [ ] 能够创建和使用 DataHandler
- [ ] 能够创建数据集并划分训练/验证/测试集

如果所有项目都已完成，您已经掌握了 Qlib 的特征工程方法！
